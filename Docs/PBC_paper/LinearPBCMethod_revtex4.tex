% NOTE TO AIP TYPSETERS: TO CONVERT FROM TWO-COL TO PREPRINT, SWITCH
% COMMENTOUT COMMAND FROM A TO B IE. use
% \newcommand{\commentoutA}[1]{}
% \newcommand{\commentoutB}[1]{#1}
% instead of the following
\newcommand{\commentout}[1]{}
\newcommand{\commentoutA}[1]{#1}
\newcommand{\commentoutB}[1]{}
%\renewcommand{\thefootnote}{\fnsymbol{footnote}}

\commentoutA{\documentclass[prb,aps,nobibnotes,twocolumn,doublespace,twocolumngrid,superbib,showpacs]{revtex4}}
\commentoutB{\documentclass[prb,aps,nobibnotes,twocolumn,doublespace,twocolumngrid,superbib,showpacs.preprint]{revtex4}}

\usepackage{graphicx}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{alltt}

\begin{document}

\date{\today}

\title{Linear scaling computation of the Fock matrix VII.  \\
       Periodic Density Functional Theory a the $\Gamma$-point.}

\author{C.J. Tymczak}
\affiliation{Theoretical Division, Los Alamos National Laboratory, Los Alamos, New Mexico 87545 }
\author{Matt Challacombe}
\affiliation{Theoretical Division, Los Alamos National Laboratory, Los Alamos, New Mexico 87545 }

\begin{abstract}
Periodic boundary conditions have been implemented in the linear scaling
Quantum Chemistry code \textbf{MondoSCF}. For the two-electron Coulomb
matrix, this has been achieved with an exact multipole expansion of
the long range Coulomb field. This yields a spherically summed boundary
condition that is easily transformed to Ewald boundary conditions.
In order to achieve linear scaling of the local Coulomb field, a Quantum
Chemical Tree Code (QCTC) is used. Periodic boundary conditions have
also been incorporated into calculations of the local exchange-correlation
matrix and the exact-exchange matrix. A Hierarchical Cubature (HiCu),
pure Cartesian adaptive grid is used for the local exchange-correlation
matrix. This method achieves linear scaling through the use of advanced
data structures (k-d trees) that maximally exploits locality of the
density. Finally, the current capabilities of MondoSCF for large condensed
phases will be demonstrated.
%
\vskip 0.07 in
\noindent{\bf Keywords}: Self-consistent-field, linear-scaling, periodic systems, tree-code, Gaussian-orbital
%
\end{abstract}

\pacs{71.10.-w,71.15.-m,71.20.-b,31.15.Ne}

\maketitle

\footnotetext[1]{\tt tymczak@lanl.gov}
\footnotetext[2]{Preprint LA-UR-03-7723.}

\section{INTRODUCTION}
In recent years several successful methods for the calculating the electronic structure of
molecular or condensed matter systems have been developed,
for example Hatree-Fock \cite{slater,CRoothaan51}, Density Functional theory 
\cite{hohen,KohnSham65} or Configuration interaction \cite{Choudhury79}. 
All these methods attempt to solve for the electronic structure via
the many-body quantum problem to within some consistent approximation scheme.
For complex molecular or condensed matter 
system, where chemical reactions are of central importance, these electronic structure
method are essential. Unfortunately, most electronic structure quantum chemistry codes
scale very poorly with system size due to the need to diagonalize the Hamiltonian,
which scales $O(N^3)$ 
%
% Should cite standard comercial code like ``Gaussian''. (Ha)
%
This severely limits the systems sizes 
that these codes can address. Therefore, it has become increasing important for
the development of quantum chemistry codes which scale linearly with increasing 
system size, and several quantum chemistry codes of this type are in 
development 
\cite{SGoedecker94,MChallacombe96,Canning96,Briggs96,EHernandez96,Scuseria99,ANiklasson02B}. 
However, for reasons of simplicity most of these quantum 
chemistry codes have yet to incorporate periodic boundary conditions.
Unfortunately many
technically important systems can only be addressed within a condensed phase environment,
where surface effects have been removed \cite{MAllen90}. Therefore, the inclusion of 
periodic boundary conditions into existing linear scaling quantum chemistry
codes is essential. 

We have implemented periodic boundary conditions into the linear scaling
quantum chemistry code \textbf{MondoSCF} 
\cite{MChallacombe96,MChallacombe97,MChallacombe99}.
For the one electron matrix this has been achieved by a re-summation
over periodic cell images, which because of locality leads to an efficient
calculation of the one electron matrices. For the two electron matrices
various methods are employed. For the two-electron Coulomb matrix,
we achieve this via an exact multi-pole expansion of the long range
Coulomb field \cite{White94,Challacombe97}. This yields a spherically
summed boundary condition that is easily transformed into the Ewald boundary
condition \cite{Redlack72,Redlack75}. In order to achieve linear
scaling of the local Coulomb field, a Quantum Chemical Tree Code (QCTC)
is used \cite{MWarren93,MWarren95a,JSalmon94,MChallacombe96A}. For the calculations of the 
local exchange-correlation matrix, a Hierarchical Cubature (HiCu), pure 
Cartesian adaptive grid
is used. This method achieves linear scaling through the use of advanced
data structures (k-d trees) that maximally exploits locality of the
density, and allows for an efficient treatment of the periodic effects
\cite{Bentley79}. All \textbf{MondoSCF} calculations are done at the gamma-point.
This is because the main focus of the \textbf{MondoSCF} linear scaling quantum chemistry
code is large systems, where for insulators k-space integrations become unnecessary 
\cite{Nunes94}.


To demonstrate and validate the capabilities of \textbf{MondoSCF}, we show results for 
three condensed phase systems, Sodium Chloride, Magnesium Oxide 
and Carbon in the diamond structure. We then compare these results to the periodic
Gaussian code \textbf{Crystal98} \cite{Crystal98}. Next we demonstrate that
the code achieves {\it true} linear scaling for the dense periodic diamond system 
up to 512 atoms in the unit cell.
%
% Example system
%
%To show the full capabilities of \textbf{MondoSCF} we calculate the surface reconstruction
%of the Silicon (111) surface with a step.
%
Finally we give some conclusion concerning the accuracy and utility of \textbf{MondoSCF}
and future research directions.

\commentout{

\section{The Kohn-Sham Equations}

Following the seminary work of Kohn and Sham\cite{KohnSham65}, we start with the KS single 
particle equation
\begin{equation}
H \phi_{i}({\bf r})  = \epsilon_i \phi_{i}({\bf r})
\end{equation}
where the effective Hamiltonian is
\begin{equation}
H = -{\nabla}^{2}+ V_{ext}({\bf r}) + J[\rho({\bf r})] + K_{xc}[\rho({\bf r})]
\end{equation}
and
\begin{equation}
 \rho({\bf r}) = \sum_{i=1}^{N_{el}} | \phi_{i}({\bf r}) |^2
\end{equation}
\begin{equation}
 J[\rho({\bf r})] = \int d{\bf r'} {\rho({\bf r}) \over |{\bf r}-{\bf r'}|},
\end{equation}
and the exchange correlation potential can be calculated from several approximate
functionals
\cite{Becke93,Hertwig97,Bauschlicher95,Adamo00}. In what follows we will 
discuss the calculation of each of the terms in the Hamiltonian 
and how they are calculated in the non-orthogonal Gaussian basis
with the inclusion of periodic boundary conditions.
}

\section{periodic boundary conditions, linear scaling and basis sets}

In the conventional implementations of periodic boundary conditions, the 
Bloch functions 
\begin{equation}
\psi^{\bf k}_a({\bf r})  =  \sum_{\bf R} e^{i {\bf k}\cdot {\bf R}} \phi_a ({\bf r}-{\bf R}),
\label{Block}
\end{equation}
are often constructed from non-orthogonal functions local to the unit cell (UC). Here, the 
local function
$\phi_a$ is a Gaussian-Type Atomic Orbital (GTAO) centered on atom {\bf A}, while the 
sum on {\bf R} runs over the Bravais lattice defined by integer translates of the primitive 
lattice vectors {\bf a}, {\bf b} and {\bf  c}, and {\bf k} are the reciprocal 
Bravais Lattice vectors.
These Bloch functions (crystal orbitals)
yield all possible translational symmetries through variation of the reciprocal lattice vector 
{\bf k}.     
For small system sizes with high symmetry, a careful sampling of reciprocal space is required  
for an accurate description of the periodic system.  An alternative approach to including these 
important symmetries is to set ${\bf k}=0$, and then use a larger supercell created through 
replication and translation of the primitive unit cell.  
This is the supercell $\Gamma$-point approximation, used
primarily for the study of defects and vacancies rather than as a replacement for 
${\bf k}$-space integration,
perhaps due to the expense of conventional algorithms and slow convergence for small gap systems.

In this contribution, ${\cal O}(N)$ algorithms are developed specifically for the the 
$\Gamma$-point 
approximation, allowing the use of large supercells in the case of high symmetry and large 
primary unit cells
in the case of disordered systems.  While the ${\bf k}$  dependence is avoided, lattice 
summation and formal integration over 
the unit cell volume, $V_{\rm UC}$ are retained. At first sight this would seem to make matrix 
construction quite 
different than in the gas phase,  where integrals are typically taken over all space, 
$V_\infty$.  
Thus, elements of the gas phase overlap matrix 
\begin{equation}
\label{Sab_norm}
S_{ab}=\int _{V_{\infty }}\, d{\mathbf{r}}\, \phi _{a}({\mathbf{r}})\phi _{b}
({\mathbf{r}})
\end{equation}
become 
\begin{equation}
\label{Sab_pbc1}
S_{ab}=\sum _{\mathbf{R},\mathbf{R}'}\int _{V_{\rm UC}}\, d{\mathbf{r}}\, 
\phi _{a}({\mathbf{r}+\mathbf{R}})\phi _{b}({\mathbf{r}+\mathbf{R}'})
\end{equation}
in the periodic regime.  
However, this formalism can be changed via the 
transformation,
\begin{equation}
\sum_{\bf R} \int_{V_{\rm UC}} d {\bf r} f({\bf r+R}) \rightarrow \int_{V_\infty} d {\bf r} f({\bf r}),
\end{equation}
allowing use of conventional analytic integral technologies \cite{JWhitten73,LMcmurchie78,VSaunders83}.  
For example, elements of the periodic overlap matrix become
\begin{equation}
\label{Sab_pbc2}
S_{ab}=\sum _{\mathbf{R}}\int _{V_{\infty }}\, d{\mathbf{r}}\, \phi _{a}
({\mathbf{r}})\phi _{b}({\mathbf{r}+\mathbf{R}}).
\end{equation}
%
%


For compactness of notation, let us define the corresponding intermediate basis function products (distributions)
$\rho _{ab}^{\scriptscriptstyle \infty}({\mathbf{r}})=\sum _{\mathbf{R}}\phi _{a}({\mathbf{r}})\phi _{b}
({\mathbf{r}+\mathbf{R}})
$ associated with integration over $V_\infty$.  We likewise define an intermediate 
electron density $\rho^{\scriptscriptstyle \infty}({\bf{r}})= \sum _{ab} P_{ab} 
\rho _{ab}^{\scriptscriptstyle \infty}({\mathbf{r}})$,
where $P_{ab}$ is the one-electron reduced density matrix.  
In this convention, $V_\infty$ is the default volume of integration, and elements of the periodic overlap 
matrix are expressed simply  as $S_{ab}=\int  d{\mathbf{r}}\, \rho^{\scriptscriptstyle \infty}_{ab}({\mathbf{r}})$,
 while the electron count is
$N_{\rm el} =\int  d{\mathbf{r}}\, \rho^{\scriptscriptstyle \infty}({\mathbf{r}})$.

It is worth noting that the complexity of $\rho^{\scriptscriptstyle \infty}$ is ${\cal O}(N)$, due to the
exponential prefactor $e^{- \chi_{ab} ({\bf A}-{\bf B}-{\bf R})^2}$ that enters each term in the sum 
over {\bf A}, {\bf B} and {\bf R}.  Thus, $N$-scaling may be achieved {\em a priori} with a simple distance test.
However, for small exponents, care must be exercised in  truncation of periodic sums to avoid overlap 
matrices that are not positive definite.  While these situations can be avoided simply with tighter distance neglect 
criteria, they are often due to the use of basis sets designed for gas phase calculations in conjunction with small 
unit cells.  

These considerations and others are discussed by Towler in an excellent overview of Gaussian basis sets for the condensed 
phase \cite{MTowler00}.  Also, there are at least two libraries\cite{CrystalLib,TowlerLib} of Gaussian 
basis sets appropriate for materials at standard densities. For high densities though, these basis sets may 
still encounter problems with linear dependence and sensitivity to truncation.  One solution to this problem, suggested 
by Gr{\"u}neich and Hess \cite{AGruneich98} for even tempered basis sets, is to scale the exponents by the inverse 
square  of the lattice constant.  
In many cases though, especially for large systems, standard quantum chemistry basis sets work well. 

%%\cite{}.
%% CyrstalLib http://www.crystal.unito.it/Basis_Sets/ptable.html
%% TowlerLib http://www.tcm.phy.cam.ac.uk/~mdt26/crystal.html

\section{data structures and error estimates}\label{datastruct}

Both the Quantum Chemical Tree-Code (QCTC) 
%\cite{} 
for computing the Coulomb matrix and Hierarchical Cubature (HiCu)
for computing the Exchange-Correlation matrix are fast ${\cal O}(N {\rm lg} N)$ algorithms whose performance
is intimately coupled to underlying data structures and error estimates.  It is important to understand some 
of these particulars first, before addressing their extension to periodic boundary conditions.
Also, the current version of QCTC is quite different from previous descriptions \cite{MChallacombe96B}, and deserves some
introduction.  


Both QCTC and HiCu are homeomorphic, involving $k$-d tree representation of the density.  
In our implementations, $k$-d trees are doubly linked lists with axis aligned bounding boxes (AABBs) 
containing the spatial {\em extent} of each node and its children.    This scheme is similar to
well developed technologies for ray tracing and data base searches, allowing fast 
${\cal O}({\rm lg} N)$ {\em range queries} of overlapping components through AABB intersection tests 
%\cite{}. 
In the case of QCTC, this fast look up constitutes the penetration acceptability criterion (PAC) 
%\cite{}, 
which identifies
spatial clusters or agglomerations, $\rho_Q$, of the density that may be accurately represented via a multipole 
approximation due to the absence of charge-charge penetration effects.  For accepted agglomerations a second test, 
the multipole acceptability criterion (MAC), is performed to check translation errors in the multipole 
expansion. 
%\cite{}.  
For each primitive bra distribution, this fast range query is performed on the $k$-d tree 
representation of the total density, leading to an on the fly partition of near-field (NF) and far-field (FF) 
interactions in construction of the gas phase Coulomb matrix,
\begin{eqnarray}
J_{ab} &=& \sum_{Q\in \rm FF} \sum_l \sum_m O^l_m[\rho_{ab}] \sum_{l'} \sum_{m'} M^{l+l'}_{m+m'} O^{l'}_{m'}[\rho_Q] 
\nonumber \\
&+& \sum_{q\in \rm NF} \int d {\bf r} \int d {\bf r'} \rho_{ab} ({\bf r}) \left|{\bf r}-{\bf r'} \right|^{-1}
\rho_q({\bf r}) 
\end{eqnarray}
where $M^l_m$ is the irregular solid harmonic interaction tensor, $O^l_m[f]=\int d{\bf r} O^l_m({\bf r}) f({\bf r})$
is a moment of the regular solid harmonic, 
%\cite{}, 
$Q$ runs over the  highest possible nodes in the density-tree as determined by PAC and MAC and 
$q$ runs on the left over near-field primitive distributions in the density.
The QCTC near/far-field partition pushes the multipole approximation to the limit, employing a new   
error estimates that depend on the magnitude and extent of both bra and ket \cite{CTymczak04c} 
and allowing tree traversal to the resolution of primitive distributions.  
While resolving individual primitives forgoes well developed technologies for the 
integral evaluation of contracted functions, it accelerates the onset of linear scaling through the early
clustering of close distributions.

The Quantum Chemical Tree Code generally employs the total density, which simplifies the code, allows 
electrostatic screening in MAC error estimates 
%\cite{} 
and provides charge neutrality, an essential
feature for periodic calculations.  Thus, the Coulomb matrix employed here includes the electron-nuclear terms;
${\bf J} \equiv {\bf J} + {\bf V}_{\rm en}$.


In the case of HiCu, two separate $k$-d tree structures are used.  The rho-tree holds the electron density,
while the cube-tree contains a hierarchical grid for integration of the exchange-correlation potential.  Each 
node of the 
cube-tree is composed of a Cartesian non-product integration rule with the grid points enclosed by it's AABB.
The cube-tree is constructed iteratively through recursive bisection of the primary volume (the root AABB), using 
exact error bounds to achieve arbitrary precision of the integrated density and its gradients.   As the cube-tree 
is extended, AABB intersection tests are performed while traversing the rho-tree,  avoiding parts of the density 
that do not overlap with that portion of the grid.  Upon construction of the grid,  the inverse procedure is
 carried out;  
for each primitive distribution, the cube-tree is walked selecting only overlapping portions of the grid via the AABB 
intersection test.

For both of these fast algorithms, the trade off between efficiency and accuracy is controlled by the AABB,  
which in turn 
depends on the the extent or range $R_q$ of a primitive Gaussian distribution $\rho_q$, beyond which it is assumed to 
have negligible influence.  Of coarse, negligible depends on the use to which the distribution is put, as will become 
obvious in the following. 

Both HiCu and QCTC employ the Hermite Gaussian representation of distributions
\begin{equation}
\rho_q ({\bf r}) = \sum_{lmn} d_{lmn} \Lambda^q_{lmn}({\bf r}),
\end{equation}
where 
\begin{equation}
\Lambda^q_{lmn}({\bf r}) = \frac{\partial^{l+m+n} }{\partial Q^l_x \partial Q^m_y \partial Q^n_z} 
e^{-\zeta_q ({\bf r}-{\bf Q})^2}.
\end{equation}
This representation provides an intermediate form into which elements of the density matrix may be folded, and allows
the use of McMurchie-Davidson recurrence relations 
%\cite{} 
in analytic integral evaluation and density evaluation.
For this form,  Cramer's inequality 
%\cite{} 
provides a bound for the behavior of a Hermite-Gaussian distribution: 
\begin{equation}
\rho_q ({\bf r})  \leq C_q e^{ -\widetilde \zeta_q ({\bf r -Q})^2 },  
\end{equation}
where
\begin{equation}
C_q=\sum_{lmn} \left|d_{lmn}\right| K^3 \left[ 2^{l+m+n} ~ l! m! n! ~ \zeta^{l+m+n}_q \right]^{1/2} ,
\end{equation}
the constant $K=1.09$ and  
\begin{equation}
\widetilde \zeta_q = 
\begin{cases}
\zeta_q   & l+m+n= 0 \\
\frac{1}{2} \zeta_q   & {\rm otherwise.}
\end{cases}
\end{equation}


For HiCu, the overlap extent $R^{\rm o}_q$ is used, beyond which numerical evaluation of the 
distribution $\rho_q$ yields an accumulation less than $\tau$;
\begin{equation}
C_q e^{ -\widetilde \zeta_q (R^{\rm o} _q)^2 }  = \tau .
\end{equation}
For QCTC,  errors in the electrostatic potential due to penetration errors must be considered.
For this purpose, the penetration extent $R^{\rm p}_q$ is introduced, satisfying the equation 
\begin{equation}
C_q \int \left[ \left(\pi/{\widetilde \zeta_q} \right)^{3/2} 
\delta({ r})  - e^{ -\widetilde \zeta_q {r}^2 } \right] \left|{ r}-{ R^{\rm p}_q} \right|^{-1} {\rm d} r = \tau .
\end{equation}


In both HiCu and QCTC, the density-tree is constructed by recursively splitting the largest
box dimension, until each primitive has been resolved.  Then the primitive AABBs are computed from their
extents and merged recursively back up the tree.  For HiCu, this is all there is to it, but for QCTC multipole
moments are also translated to a common center and recursively merged up the tree.  Also, when computing 
matrix elements of $\bf J$, the primitive bra AABB is computed with $R^{\rm o}_q$, while  $R^{\rm p}_q$ are 
used to construct AABBs of the density-tree.

In Fig.~1, differences between the penetration and overlap extent are shown for a diffuse $s$-type
Gaussian.  For large extents, such as those encountered in a static FMM-type error bound, the two extents are 
equivalent.  However, with aggressive use of the multipole approximation as in QCTC, the distinction becomes
critical. 

%
% Figure 1
%
\begin{figure}
\includegraphics{Extent_2.ps}
\caption{Behavior of the overlap extent $R^o$ and the penetration extent $R^p$ 
	 as a function of $\tau/C_q$ for an $s$-type Gaussian with exponent $\zeta=1$. 
         For small $C_q$ (occurring for example due to a large atom-atom separation and/or small density 
         matrix prefactor), $R^o$ goes to zero at the origin and its distribution is eliminated, 
         while $R^p$ goes slowly to zero due to the Coulomb singularity.}
\label{extent}
\end{figure}

\section{Periodic Quantum Coulomb Sums}

In the $\Gamma$-point approximation, elements of the periodic Coulomb matrix are 
\begin{eqnarray}
J_{ab}&=&\frac{1}{2}\int _{V_{\rm UC}} d{\mathbf{r}}  \int 
d{\mathbf{r}'}{\rho _{ab}\left( {\mathbf{r}}\right) {\left| \mathbf{r}-\mathbf{r}'\right| }^{-1}
\rho_{\rm tot}\left( \mathbf{r}'\right) } \\
&=& \frac{1}{2}\sum _{\mathbf{R}}\int\int
d{\mathbf{r}}\, d{\mathbf{r}'}{\rho _{ab}^{\scriptscriptstyle \infty}\left( {\mathbf{r}}\right)  
{\left| \mathbf{r}-\mathbf{r}'\right| }^{-1} \rho^{\scriptscriptstyle \infty}_{\rm tot}
\left( {\mathbf{r}'}+{\mathbf{R}}\right) }
\nonumber 
\end{eqnarray}
where $\rho_{\rm tot}$ is the total, periodic density including both electronic and nuclear terms.  These integrals
involve infinite summation over the lattice vectors ${\bf R}$, and must be handled with care.  There are at least two
main approaches to handling this summation:  Multipole expansion of the Ewald potential 
%\cite{},
or Ewald-like summation of the multipole expansion. Expansion of the Ewald potential yields  
tin foil (TF) boundary conditions, requires reciprocal and real space summation with every ${\bf J}$ build, 
and scales as $O(N^{3/2})$.  An alternative is the Ewald-like summation of the multipole interaction tensor,
which was first described by Nijboer and De Wette (NDW) 
%\cite{} 
and later reviewed and extended by us 
%\cite{}
to lattice summation of the irregular solid harmonic multipole interaction tensor. 
This Ewald-like summation is taken over the periodic far field, $V_{\rm PFF}$, which is direct lattice summation 
excluding 
an inner region, $V_{\rm in}$, surrounding the unit cell.  This inner region has been subtracted to avoid penetration
errors and to guarantee convergence of the multipole expansion.  Because the summed interaction tensors are cheaply 
precomputed and reused, the cost of Coulomb summation over the PFF scales as as ${\cal O}(N p^2)$, where $p$ is the 
order 
of the multipole expansion.  With this feature, achieving $N$-scaling periodic quantum Coulomb sums involves the 
contributions
\begin{equation}
{\bf J} = {\bf J}^{\rm in} + {\bf J}^{\rm PFF} + {\bf J}^{\rm TF} \, ,
\end{equation}
corresponding to the three separate regions shown in Fig.~2.   Here, ${\bf J}^{\rm in}$ is computed using 
the fast ${\cal O}(N {\rm lg} N)$ QCTC algorithm outlined previously in Section~\ref{datastruct}. Construction of 
${\bf J}^{\rm PFF}$ 
will be developed in the following section, while in Section~\ref{tinfoil} the term ${\bf J}^{\rm TF}$ necessary to 
introduce tin-foil boundary conditions is detailed.
%
% Figure 2
%
\begin{figure}
\includegraphics{Regions.eps}
\caption{Schematic of the regions contributing to $N$-scaling summation of the Coulomb matrix.
The inner cells that make up $V_{\rm in}$ provide a buffer region that guarantees convergence of the multipole 
expansion of Coulomb interactions between the unit cell and all cells in $V_{\rm PFF}$.  The
periodic far-field region, $V_{\rm PFF}$, is the spherically ordered lattice extending
to infinity but excluding $V_{\rm in}$.  For large cells and/or high order multipole 
expansions, $V_{\rm in}$ includes just the unit cell and its nearest 27 neighbors.  In fast multipole
method notation this corresponds to a well-separated index of unity.  However, for smaller cells and/or lower 
order multipole expansions, $V_{\rm in}$ tends to a spherical distribution of cells surrounding the unit cell.   
Direct summation over $V_{\rm PFF}$ leads to charges at the infinite surface  $S_{\infty}$, which must be
be canceled by tin-foil (conducting) boundary conditions to achieve equivalence with Ewald summation.}
\label{regions}
\end{figure}

\subsection{The Periodic Far Field}\label{pff}

By construction, the periodic far field (PFF) term in the Coulomb matrix,
\begin{equation}
J_{ab}^{\rm PFF} = \sum _{{\bf R}\in {\rm PFF}} \int \int d {\bf r} d {\bf r'}  \rho^\infty_{ab}
({\bf r}) {\left| {\bf r}-{\bf r'}+{\bf R} \right|}^{-1}
\rho^\infty_{\rm tot} ({\bf r'}),
\label{PFFOne}
\end{equation}
involves charge distributions that are well separated with respect to both penetration and the
convergence of multipole expansion errors, as outlined in Fig.~2 and discussed in the following. 

With these conditions, and assuming the unit cell is centered at the origin, the bipolar multipole expansion 
employing the regular and irregular solid harmonics, $O^l_m$ and $M^l_m$ respectively, 
\begin{eqnarray}
{| {\bf r}-{\bf r}'+{\bf R}|}^{-1} &\approx&
\sum^p_{l=0} (-1)^{l}  \,
\sum^p_{l'=0} \Bigl[
\\
&&\sum^{l}_{m=-l} \,
\sum^{l'}_{m=-l'} 
O^{m}_{l}({\bf r})
            \,M^{m+m'}_{l+l'}({\bf R})
            \,O^{m'}_{l'}({\bf r}')  \Bigr] , \nonumber
\end{eqnarray}
may be inserted into Eq.~(\ref{PFFOne}) yielding
\begin{eqnarray}
J_{ab}^{\rm PFF}& =&\sum _{{\bf R}\in {\rm PFF}} \sum^p_{l=0} (-1)^{l}  \, \sum^p_{l'=0} \sum^{l}_{m=-l} 
\Bigl(  \\
&&
\sum^{l'}_{m=-l'} 
O_{l}^{m}\left[ \rho^\infty_{ab}\right]\,M^{m+m'}_{l+l'}({\bf R}) \, O_{l'}^{m'}\left[ \rho^\infty_{\rm tot}\right] 
\Bigr) ,  \nonumber
\end{eqnarray}
This expression decouples the complexity of $\rho^\infty_{ab}$ from $\rho^\infty_{\rm tot}$
through the precomputed multipole moments
$O_{l}^{m}\left[ \rho^\infty_{ab}\right] 
=\int  d\mathbf{r}\, {O}_{l}^{m} \left( \mathbf{r}\right) \, \rho^\infty_{ab} \left( \mathbf{r}\right) $
and 
$O_{l}^{m}\left[ \rho^\infty_{\rm tot}\right] =\int  d\mathbf{r}\, {O}_{l}^{m} \left( \mathbf{r}\right) \, 
\rho^\infty_{\rm tot} \left( \mathbf{r}\right)$.
Following Nijboer and De Wette, we introduce the effective multipole interaction tensor 
\begin{equation}
{\cal M}^{m}_l=\sum_{{\bf R}\in V_{\rm PFF} } M^m_l({\bf R}) \;,
\end{equation}
which can be efficiently computed on the fly for each new lattice, both to high accuracy and to high order (large $p$) 
using the new methods detailed in Appendix~\ref{calMTen}.  With this simplification,  the 
${\cal O}(p^2 N)$  working equation 
\begin{equation}
\label{WorkingPFF}
J_{ab}^{\rm PFF}= \sum^p_{l=0} \sum^{l}_{m=-l} O_{l}^{m}\left[ \rho^\infty_{ab}\right] {\cal J}^m_l \;,
\end{equation}
is obtained, where the intermediate tensor 
\begin{equation}
{\cal J}^l_m = (-1)^{l}\sum^p_{l'=0} \sum^{l'}_{m=-l'}  {\cal M}^{m+m'}_{l+l'} O_{l'}^{m'}
\left[ \rho^\infty_{\rm tot}\right] 
\end{equation}
is cheaply precomputed at the start of each Coulomb build.


Because Eq.~(\ref{WorkingPFF}) is inexpensive, our strategy is to define a minimal buffer region, $V_{\rm in}$,
 sufficient 
to control penetration errors, subtracting effort from the computation of $J^{\rm in}$ via QCTC and replacing
it with cheaper, multipole work in the computation of $J^{\rm PFF}$.  To this end, a fixed inner region $V_{\rm in}$ 
is constructed 
from neighboring cells that have simple Gaussian overlap with the unit cell, defined by the radius $R^{o}$.  
As explained in Section~\ref{datastruct}, for the relatively large distances considered at this level the differences 
between the
penetration and overlap extent are negligible. 
With $V_{\rm in}$ fixed, the precision of ${\bf J}^{\rm PFF}$ is controlled entirely by the expansion order $p$.  
In general $p \gtrsim 20$ will be much higher than the expansion order ($\sim 5$) employed by QCTC in computation of 
${\bf J}^{\rm in}$.  
With QCTC accuracy is controlled on the fly by the MAC and PAC, establishing a dynamic near/far-field partition, while 
computation of ${\bf J}^{\rm PFF}$ involves a static, worst case error dominated by the multipole expansion.  
This static error is controlled by using the FMM-like error bound, 
\begin{equation}
\frac{ 2^{p} {\cal C}^2 \,{d}_{\rm max}^{p+1}}
{({R}^o)^{p+1}\left| {R}^o -2 \, {d}_{\rm max} \right| } 
\leq \tau \;,
\end{equation}
where $d_{\rm max}$ is the maximum translational distance, ${\cal C}$ is the Uns{\"o}ld weight of the system
and $\tau$ is a threshold controlling the precision. This expression is developed in Ref.~\onlinecite{CTymczak04c},
stemming from new error bounds for the tree-code MAC that are both cheap and sensitive to the particulars
of the expansion, including magnitude of the charges etc, captured by the  Uns{\"o}ld weight ${\cal C}$.  Because 
${\cal C}$ will fluctuate slightly with the density between self-consistent-field cycles, so to will the
expansion order~$p$.  


\subsection{Tin-Foil Boundary Conditions}\label{tinfoil}

The surface charges created by direct summation over $V_{\rm PFF}$ must be canceled
to achieve equivalence with Ewald summation.   Achieving this equivalence is more than
semantic, since without tin-foil boundary conditions matrix elements lack translational
invariance and often incur dramatic charge sloshing instabilities.   The correction is 
strongly dependent on ordering of the direct sum; as the Nijboer and De Wette 
summation corresponds to spherical summation due to symmetry of the real/reciprocal space
partition, the appropriate correction is \cite{Redlack72} 
\begin{equation}
\Phi _{\rm Ew}\left( \mathbf{r}\right) =\Phi _{\rm SS}\left( \mathbf{r}\right) + 
\frac{2\pi }
{3V_{\rm UC}} \left(  Q - 2 \, {\bf r } \cdot \mathbf{D} \right),
\label{EW_pot}
\end{equation}
where ${\bf D}$ is the system dipole moment and $Q$ is trace of the system quadrupole, and 
we have assumed origin centering, 
The tin-foil correction to the Coulomb matrix is then 
\begin{equation}
J_{ab}^{TF}  = \frac{2\pi }{3V_{\rm UC}} \left(  Q\, S_{ab}-2 \, \mathbf{d}_{ab}\cdot 
\mathbf{D} \right) \label{JTC}
\end{equation}
with  $S_{ab}$ an element of the overlap matrix, and ${\bf d}_{ab}$ the
dipole moment of the distribution $\rho^\infty_{ab}$.  

%
% Figure 3
%
\begin{figure} 
\includegraphics{BoxUC.eps}
\caption{Transformation between the rectangular integration volume $V_\Box$ employed by 
HiCu and the unit cell with volume $V_{\rm UC}$, described by the vectors {\bf a}, 
{\bf b} and {\bf c}.}
\label{boxuc}
\end{figure}


\section{Periodic exchange-correlation} 

The HiCu algorithm is ideally suited for periodic boundary conditions, 
as the unit-cell $V_{\rm UC}$ can be simply transformed into an equivalent rectangular 
integration domain $V_\Box$ which is the cube-tree's AABB.  These volumes,
shown in Fig.~3,  are equivalent due to full periodicity of the distributions 
and the density. The integration is then simply,
%
\begin{equation}
K_{ab} = \int _{V_{\Box}}\, d\mathbf{r}\, \rho_{ab}^{\infty}({\bf r}) V_{xc}(\rho^{\infty}_{tot};{\bf r})
\label{Kxc_pbc_0}
\end{equation}
%
However, because the distributions and density involve a double sum over 
lattice vectors, there will be a large number of atom-atom pairs that do not overlap
with $V_\Box$.  A similar situation is encountered in the gas phase for parallel versions 
of HiCu \cite{CGan03}, where each processor has a small, local cube-tree that may 
overlap only a few of the many possible atom-atom pairs.  

The solution again comes from the ray tracing literature, in the form of a modified 
ray-AABB \cite{MGomez99} and sphere-AABB test \cite{GGems}.  
%     ! Modified Miguel Gomez' Ray-AABB test (Gamasutra '99) to work for Cylinder-AABB
%     ! for Ray=Point, uses A Simple Method for Box-Sphere Intersection Testing, Graphics Gems, pp. 247-250
The ray-AABB test has been modified into a cylinder-AABB test, where the radius of the cylinder
is a maximal overlap extent of the atom-atom pair.  In the case of a same center atom-atom pair,
it is of coarse more appropriate to employ a sphere-AABB test.  In both cases, overlap
between the HiCu integration volume and atom-atom pairs is established with a negligible prefactor.
\commentout{
To calculate the DFT exchange correlation matrix in the periodic case,
we take advantage of the periodicity of the functions being integrated
and the locality of the basis functions \cite{Gill92},
%
\begin{eqnarray}
K_{ab}^{PBC} &=& \int _{V_{cell}}\, d\mathbf{r}\, \rho_{ab}^{PBC}({\bf r})
\frac{\delta E}{\delta \rho^{PBC}} \nonumber\\
&+&\nabla  \rho_{ab}^{PBC}({\bf r}) \cdot \nabla \rho^{PBC}({\bf r})
\frac{\delta E}{\delta  \nabla \rho^{PBC}}
\label{Kxc_pbc_0}
\end{eqnarray}
%
But because of the periodicity and locality of the density 
\begin{equation}
V_{cell} \rightarrow V_{HiCu}
\end{equation}
%
where \( V_{HiCu} \) is the cubic region shown in Fig.~3.
This transformation is ideally suited for the method we use to calculate
our exchange-correlation matrix, which is based on a Cartesian ``Gaussian
quadrature'' integration of a rectangular region. To calculate the
exchange correlation matrix in periodic system we need to use equation
(\ref{Kxc_pbc_0}), where the integration region id $V_{HiCu}$. 
This could be prohibitively expensive because of
the double sum (do to $\rho_{ab}^{PBC}$) if not for the locality of the HiCu grid. 
We have determined that the the computational cost increases by about a factor of two.
This is achieved by splitting the problem into two steps:
First, we calculate the exchange-correlation potential on the HiCu
grid using the periodically summed local density \( \rho ^{loc}\left( \mathbf{r}\right)  \),
because of the k-d tree structure of the density this is not computationally
expensive.
Next, we directly calculate the integral of equation (\ref{Kxc_pbc_0}),
where we obtain significant increase in efficacy by exploiting the
localization of the atomic orbitals. 
}

\begin{table}
\caption{Comparison of {\sc Crystal98} and {\sc MondoSCF} $\Gamma$-point calculations on  NaCl at the 
8-511/8-631G/BLYP level of theory at a {\it tight} accuracy level. The lattice coordinates for 
$N_{\rm at}=2$ and 8 are  are given in Ref.~[\cite{PBCCoordinates}].}
\label{NaCl8511}
\center{
\begin{tabular}{lcll}
\toprule
Program         & $N_{\rm at}$              & Energy (Hatree) & Energy/$N_{\rm at}$\\ 
\colrule
{\sc MondoSCF}      & $2^f$  &  -622.39101   & -311.19551  \\
{\sc Crystal98}     & $2^f$  &  -622.3911    & -311.1955    \\
{\sc MondoSCF}      & $8^g$  &  -2490.0016   & -311.25020  \\
{\sc Crystal98}     & $8^g$  &  -2490.0013   & -311.25016   \\
\botrule
$ ^f$Triclinic \\
$ ^g$Cubic
\end{tabular}}
\end{table}

\begin{table}
\caption{Convergence of the $\Gamma$-point super-cell approximation with {\sc MondoSCF} to 
         $k$-space integration with {\sc Crystal98} for NaCl at the STO-3G/LDA level
         of theory at a {\it tight} accuracy level.}\label{NaClGammaPt}
\center{
\begin{tabular}{lcll}
\toprule
Program         & $N_{\rm at}$              & Energy (Hatree) & Energy/$N_{\rm at}$\\ 
\colrule
{\sc MondoSCF}  & 2$^f$    &   -610.97536  & -305.48768   \\
                & 8$^g$    &  -2444.3584   & -305.54480   \\
                & 16$^f$   &  -4888.7002   & -305.54377   \\
                & 54$^f$   & -16499.490    & -305.54611   \\
                & 64$^g$   & -19554.956    & -305.54618   \\
                & 128$^f$  & -39109.912    & -305.54618   \\
                & 216$^g$  & -65997.977    & -305.54619   \\ 
\hline
${\sc Crystal98}^h$ & 2$^f$    &  -611.09228    & -305.54614    \\ 
\botrule
$ ^f$Triclinic \\
$ ^g$Cubic  \\
\multicolumn{4}{l}{$ ^h6\times6\times6$ $k$-space grid.}
\end{tabular}}
\end{table}

\newpage
\newpage

\begin{table}
\caption{Convergence of the$\Gamma$-point super-cell approximation with {\sc MondoSCF} to 
         $k$-space integration with {\sc Crystal98} for MgO at the 8-61G/8-51G/BLYP
         level of theory at a {\it tight} accuracy level. The lattice coordinates for 
	 $N_{\rm at}=2$ and 8 are from Ref.~[\cite{PBCCoordinates}].}
\label{MgOGammaPt}
\center{
\begin{tabular}{lrll}
\toprule
Program         & $N_{\rm at}$              & Energy (Hatree) & Energy/$N_{\rm at}$\\ 
\colrule
{\sc MondoSCF}  & 2$^f$    &  -275.09097  & -137.54548  \\
                & 8$^g$    &  -1101.7295  & -137.71618  \\
                & 16$^f$   &  -2203.6904  & -137.73065  \\
                & 54$^f$   &  -7437.7989  & -137.73702  \\
                & 64$^g$   &  -8815.2131  & -137.73771  \\
                & 128$^f$  &  -17630.430  & -137.73774  \\
                & 216$^g$  &  -29751.352  & -137.73774  \\ 
\hline
${\sc Crystal98}^h$ & 2$^f$    &   -275.47547  & -137.73774  \\ 
\botrule
$ ^f$Triclinic \\
$ ^g$Cubic  \\
\multicolumn{4}{l}{$ ^h6\times6\times6$ $k$-space grid.}
\end{tabular}}
\end{table}

\begin{table}
\caption{Convergence of the $\Gamma$-point super-cell approximation for Diamond, 
         computed with {\sc MondoSCF} at the 6-21G*/BLYP level of theory at a {\it good} accuracy level. The  
         lattice coordinates for $N_{\rm at}=8$ are from Ref.~[\cite{PBCCoordinates}].}
\label{DiamondGammaPt}
\center{
\begin{tabular}{rll}
\toprule
 $N_{\rm at}$  & Energy (Hatree) & Energy/$N_{\rm at}$\\ 
\colrule
  8    &   -303.989 &  -37.9986 \\
  16   &   -608.667 &  -38.0417 \\
  32   &   -1218.02 &  -38.0632 \\
  64   &   -2436.28 &  -38.0669 \\
  96   &   -3654.59 &  -38.0687 \\
 144   &   -5482.04 &  -38.0697 \\
 216   &   -8223.10 &  -38.0699 \\
 288   &   -10964.1 &  -38.0700 \\
 384   &   -14618.9 &  -38.0700 \\ 
\botrule
\end{tabular}}
\end{table}


\section{Implementation}

All developments were implemented in a serial version of {\sc MondoSCF} v1.0$\alpha$9 \cite{MondoSCF}, a suite of 
linear scaling Quantum Chemistry code.  The code was compiled using the Portland 
Group F90 compiler {\sc pgf90} v4.2 \cite{pgf90} with the {\tt -O1 -tp athlon} options  and with the 
Gnu C compiler {\sc gcc} v3.2.2 using the {\tt -O1} flag.  All calculations were carried out on a 
1.6GHz AMD Athlon running RedHat  {\sc Linux}v9.0 \cite{RedHat90}.   

The multipole interaction and contraction code used by QCTC in the near/far-field partition has been 
highly optimized by symbolic manipulation and factorization, using real arithmetic and expansions through
7'th order in the calculation of ${\bf J}^{\rm in}$. The computation of ${\bf J}^{\rm PFF}$ 
employs a general code for multipole contraction, allowing expansion through $p=64$.
Eigensolution of the self-consistent-field equations has been used throughout, with the corresponding
matrix thresholds and other thresholds given in Table \ref{Table:AccurLevels}.  
All calculations were performed with $C_1$ (no) symmetry.
%
% Figure 4
%
\begin{figure}
\includegraphics{PFFMultipoles_water.ps}
\caption{Error in the Coulomb energy computed with the 
Nijboer and De Wette scheme relative to true Ewald summation.  Shown
is the error in the Coulomb energy vers $p$ with one (ws=1) and two (ws=2) layers of
cells in $V_{\rm PFF}$ for a periodic system of 64 classical water molecules.}
\label{ErrrorPFF}
\end{figure}


\section{Validation}

The ability of our implementation to reproduce true Ewald summation is shown in 
Fig.~4 for a periodic system of 64 classical water molecules.
Note that with both the Ewald sum and the Nijboer and De Wette approach,  ordering the
real and reciprocal space sums is critical; high order agreement is achieved only when
the summation proceeds from the smallest to the largest terms.

The use of Cartesian Gaussian basis sets in many cases allows direct numerical 
comparison of different programs, at least to within the approximations, grids, etc 
peculiar to a code. Here, we make connection with the preeminent Gaussian orbital 
program for periodic calculations, {\sc Crystal98}.  Calculations have been carried 
out largely with basis sets optimized for the 
condensed phase\cite{CrystalLib}, which tend to have less diffuse valence orbitals.  
Tables~\ref{NaCl8511}-\ref{MgOGammaPt} make a direct comparison with {\sc Crystal98} for 
NaCl and MgO obtained with the {\sc MondoSCF} {\it tight} precision level 
%\footnote{This level of precision correspods to a distribution threshold $\tau_{\rm dist}=10^{-12}$,
%a HiCu threshold $\tau_{\rm HiCu}=10^{-8}$, a QCTC threshold $\tau_{\rm QCTC} = 10^{-10}$ and
%a $10^{-6}$ convergence in the maximum element of the density matrix.}
%({\bf IS THIS RIGHT CJ?? OR IS IT VERYTIGHT??})
delivering a relative precision of 10 digits in the converged total energy.  
For the {\sc Crystal98} calculations, we used the following threshold parameters: 
{\tt TOLDENS=10}, {\tt TOLPOT=10}, {\tt TOLGRID= 15} and {\tt BASIS=4}.   
The {\tt BASIS} parameter determines the auxiliary functions used to fit potentials
in {\sc Crystal98}, an approximation not used by {\sc MondoSCF}.  
%

In Table~\ref{NaCl8511}, comparison is made for $\Gamma$-point NaCl with the 8-511G\cite{CBS:8511G:Na} basis set
for the sodium, the 8-631G\cite{CBS:8631G:Cl} basis set for the chlorine and BLYP functional \cite{DFT_LYP:88,BLYP:88}.
%
Next, in Table~\ref{NaClGammaPt} convergence of the supercell $\Gamma$-point approximation 
is demonstrated for NaCl with the STO-3G basis set and the local density approximation
%\cite{}.
%
And in Table~\ref{MgOGammaPt}, convergence of the {\sc MondoSCF} supercell $\Gamma$-point approximation
to the {\sc Crystal98} $k$-space result is demonstrated for the 8-61G\cite{CBS:861G:MgO} basis set for the Magnesium, 
the 8-51G\cite{CBS:861G:MgO} basis set for the oxygen, and the BLYP functional.
%
Finally, in Table~\ref{DiamondGammaPt} convergence of the supercell $\Gamma$-point approximation is shown for
diamond, using the {\sc MondoSCF} {\it good} precision (targeting 6 digits), the BLYP functional and the
6-21G*\cite{CBS:621G:C} basis set.  Since {\sc MondoSCF} employs 6-$d$ and 10-$f$ functions, while {\sc Crystal98} 
employs 5-$d$ and 7-$f$, we were not able to make a direct comparison.


\section{Scaling}

%
% Figure 5
%
\begin{figure}
\includegraphics{Timing_Diamond_512_log.ps} 
\caption{Computational complexity for the ${\bf J}$ and ${\bf K}_{\rm xc}$ matrix builds
of cubic diamond at the 6-21G*/BLYP level of theory using a {\it good} (6 digit) level of precision}
\label{Scaling_Matrix_Build}
\end{figure}

%
% Figure 6
%
\begin{figure}
\includegraphics{ErrorVsNumber_Diamond512.ps}
\caption{Relative error with system size for 6-21G*/BLYP diamond targeting a precision 
of 6 digits in the total energy.}
\label{ErrorPerN} 
\end{figure}

Demonstrating perfect linear scaling at the outset,  Fig.~5 shows the CPU time for 
${\bf J}$ and ${\bf K}_{\rm xc}$
builds with  6-21G*/BLYP diamond at its standard density.  These timings correspond to a {\it good} level of accuracy, 
targeting 6 digits in the total energy and corresponding to the values listed in Table\ref{DiamondGammaPt}.
Shown in Fig.~6 is the precision of the computed energies, obtained by performing a second set 
of calculations with all thresholds reduced by an order of magnitude.
For these calculations, the largest source of error is the numerical integration performed by HiCu, as the QCTC 
thresholds are significantly more conservative. 

\section{Conclusions}

We have shown a systematic and efficient approach for incorporating periodic 
boundary conditions into the linear scaling quantum chemistry code {\bf MondoSCF}.
%
For the one electron matrices we achieved this by a re-summation
over periodic cell images, which because of locality leads to an efficient
calculation of the one electron integrals. 
%
For the two-electron Coulomb
matrix, we achieved this with an exact multipole expansion of
the long range Coulomb field. 
This yields a spherically summed boundary
condition that is easily transformed to Ewald boundary conditions.
In order to achieve linear scaling of the local Coulomb field, a Quantum
Chemical Tree Code (QCTC) is implemented. 
%
For the calculation of the local exchange-correlation
matrix, a Hierarchical Cubature (HiCu), pure Cartesian adaptive grid
is used. 
%
This method achieves linear scaling through the use of advanced
data structures (k-d trees) that maximally exploits locality of the
density, and allows for an efficient treatment of the periodic effects.
%
We then showed the capabilities of \textbf{MondoSCF} for three test condensed
phases , Sodium Chloride, Magnesium Oxide and Carbon in the Diamond
structure. We then compared these results to the periodic
Gaussian code \textbf{Crystal98}. 
In all cases we achieved excellent comparison with the  \textbf{Crystal98}
results, including k-space summation in comparison with ever 
increasing super-cells, to within the accuracy that \textbf{Crystal98} can obtain.
%
Finally, we demonstrated that \textbf{MondoSCF} achieves {\it true} linear scaling
for the Coulomb and Exchange-correlation matrix builds for
the dense periodic diamond system up to 512 atoms per unit cell. 
%
More Blah Blah Blah

\section*{ACKNOWLEDGMENTS}

We would like to acknowledge Tommy Sewell and Ed Kober for there advice
and support. We would also like to thank Anders Niklasson for his help
in preparation of this manuscript. 

\bibliographystyle{apsrmp} 
\bibliography{mondo_new}

\appendix

\section{Computation of the \protect\( {\cal M}\protect \) Tensor}\label{calMTen}

Following the work of Nijboer-De Wette \cite{BNijboer57,BNijboer58a}.
We start by first partitioning  

\begin{equation}
\label{C1}
\frac{1}{r^{l+1}}={\cal G}_{l}\left( \beta ,r\right) +{\cal F}_{l}\left( \beta ,r\right)
\end{equation}
where

\begin{equation}
\label{C2}
{\cal G}_{l}\left( \beta ,r\right) =\frac{\Gamma \left( l+\frac{1}{2},\beta ^{2}r^{2}\right) }
{\Gamma \left( l+\frac{1}{2}\right) \, r^{l+1}}
\end{equation}
\begin{equation}
\label{C3}
{\cal F}_{l}\left( \beta ,r\right) =\frac{\gamma \left( l+\frac{1}{2},\beta ^{2}r^{2}\right) }
{\Gamma \left( l+\frac{1}{2}\right) \, r^{l+1}}=\frac{\Gamma \left( l+\frac{1}{2}\right) -\Gamma 
\left( l+\frac{1}{2},\beta ^{2}r^{2}\right) }{\Gamma \left( l+\frac{1}{2}\right) \, r^{l+1}}
\end{equation}
and \( \beta  \) is a parameter which controls the convergence.
This allows the lattice sum to be partitioned into rapidly convergent
real and reciprocal space terms, and allows us to rewrite the ${\cal M}^{m}_{l}$ as
%
%
\begin{eqnarray}
{\cal M}^{m}_{l} & = & \sum _{\mathbf{R}'\in V_{out}}\, M_{l}^{m}[\mathbf{R}]
\nonumber\\
 & = & \sum _{\mathbf{R}'\in V_{out}}\widetilde{P}_{l}^{m}\left( \cos \theta _{\mathbf{R}}
\right) e^{im\phi _{\mathbf{R}}}\,  {\cal G}_{l}\left( \beta ,\left| \mathbf{R}\right| \right)
\nonumber\\
 & + & \sum _{\mathbf{R}'\in V_{out}}\widetilde{P}_{l}^{m}\left( \cos \theta _{\mathbf{R}}
\right) e^{im\phi _{\mathbf{R}}}\, 
{\cal F}_{l}\left( \beta ,\left| \mathbf{R}\right| \right)
\nonumber\\
\label{C4a0}
\end{eqnarray}
which we can then partition into a real and reciprocal space summation 
\begin{eqnarray}
{\cal M}^{m}_{l} &=&\sum _{\mathbf{R}'\in V_{out}}\, \widetilde{P}_{l}^{m}
\left( \cos \theta _{\mathbf{R}}\right) e^{im\phi _{\mathbf{R}}}\, {\cal G}_{l}\left( \beta ,\left|
 \mathbf{R}\right| \right) 
\nonumber\\
&-&\sum _{\mathbf{R}'\in V_{in}}\widetilde{P}_{l}^{m}\left( \cos 
\theta _{\mathbf{R}}\right) e^{im\phi _{\mathbf{R}}}{\cal F}_{l}\left( \beta ,\left| \mathbf{R}\right| 
\right) 
\nonumber\\
&+&\frac{4\pi ^{\frac{3}{2}}(\frac{i}{2})^{l}}{V_{cell}\Gamma \left( l+\frac{1}{2}\right) }
\nonumber\\
&&\sum _{\mathbf{G}\neq \left\{ \emptyset \right\} }\, \left| \mathbf{G}\right| ^{l-2}e^{-\frac{\pi ^{2}\left|
 \mathbf{G}\right| ^{2}}{\beta ^{2}}}\widetilde{P_{l}}^{m}\left( \cos \theta _{\mathbf{G}}
\right) e^{im\phi _{\mathbf{G}}}
\nonumber\\
\label{C4}
\end{eqnarray}
With an appropriate choice of \( \beta \sim \sqrt{\pi }/\left( V_{cell}\right) ^{\frac{1}{3}} \)
the periodic multipole interaction tensor can be computed. The only
potential problem is the computation of the incomplete gamma functions.
Previous approaches attempted to compute this function by the upward
recurrence relation

\begin{equation}
\label{C5}
\Gamma \left( m+1,\, x\right) =m\Gamma \left( m,\, x\right) +x^{m}e^{-x}
\end{equation}
which is started by

\begin{equation}
\label{erfc}
\Gamma \left( \frac{1}{2},\, x\right) =\sqrt{\pi }\, {\rm erfc}\left( \sqrt{x}\right) 
\end{equation}
however, this leads a numerical instability in the calculation. For
large values of \( x \) and \( m \) the calculation of the gamma
function can quickly lose precision. We can remove this problem by
analytically summing the gamma function, collecting terms, and then
rewriting the gamma function as
\begin{eqnarray}
\Gamma \left( m+\frac{1}{2},\, x\right) =\Gamma \left( m+\frac{1}{2}\right) 
\qquad\qquad\qquad
\nonumber\\
\left\{ {\rm erfc}\left( \sqrt{x}\right) 
+\sqrt{\frac{x}{\pi }}\sum _{n=0}^{m-1}(S_{n}\, x\, e^{-\frac{x}{n}})^{n} \right\}
\label{C7}
\end{eqnarray}
where

\begin{equation}
\label{SN}
S_{n}=\left( \frac{\Gamma \left( \frac{1}{2}\right) }{\Gamma \left( n+\frac{3}{2}\right) }
\right) ^{\frac{1}{max(n,1)}}
\end{equation}
Which are tabulated beforehand. We find that this version of the gamma
function is both easy to program and numerically very precise, even
at large \( x \) or \( m \). 
We can also compute the \( {\cal M} \) tensor in one and two dimensions.
The \( {\cal M} \) tensor in one dimension can be computed analytically
%
\begin{eqnarray}
{\cal M}^{m}_{l} & = & \sum _{{\mathbf{R}'}\in V_{out}}\, M_{l}^{m}[\mathbf{R}]
\nonumber\\
& = & \sum _{{\mathbf{R}'}\in V_{out}}\, \widetilde{P}_{l}^{m}\left( \cos \left( 
\theta _{\mathbf{R}}\right) \right) e^{im\phi _{\mathbf{R}}}\, \left\{ \frac{1}{r^{l+1}}\right\} 
\nonumber\\
\label{C7a0}
\end{eqnarray}
which can be written as
\begin{eqnarray}
{\cal M}^{m}_{l} & = & 
\frac{\widetilde{P}_{l}^{m}\left( \cos \left( \theta _{0}\right) \right) e^{im\phi _{0}}}{a_{0}^{l+1}}
\sum _{n=n_{0}}^{\infty }\frac{1}{n^{l+1}}
\nonumber\\
&+&\frac{\widetilde{P}_{l}^{m}\left( \cos \left( \theta _{0}+\frac{\pi }{2}\right) \right) 
e^{im\left( \phi _{0}+\pi \right) }}{a_{0}^{l+1}}
\sum _{n=n_{0}}^{\infty }\frac{1}{n^{l+1}}
\nonumber\\
& = & Q_{l}^{m}\left[ a_{0},\theta _{0},\phi _{0}\right] \left\{ \zeta (l+1)-
\sum _{n=1}^{n_{0}-1}\frac{1}{n^{l+1}}
\right\}
\nonumber\\
\label{C9}
\end{eqnarray}
%
where \( a_{0} \), \( \theta _{0} \) and \( \phi _{0} \) are the
initial box dimension and angles which are independent of the summation, and 
$\zeta (l+1)$ is the Riemann zeta function.
In two dimension, the Fourier integrals for the calculation of \( {\cal M} \)
tensor become a lot more complicated, therefore we have chosen to
use the three dimensional formula's and obtain the two dimensional
moments via numerical integration, where we take the limit as the
non-periodic direction goes to infinity,

\begin{eqnarray}
{\cal M}^{m}_{l} 
 & = & \sum _{{\mathbf{R}'}\in V_{out}}\, \left( l-m\right) !\, P_{l}^{m}\left( \cos 
\left( \theta _{\mathbf{R}}\right) \right) e^{im\phi _{\mathbf{R}}}\, {\cal G}_{l}\left( \beta ,\left| 
\mathbf{R}\right| \right) 
\nonumber\\
 & - & \sum _{{\mathbf{R}'}\in V_{in}}\, \left( l-m\right) !\, P_{l}^{m}\left( \cos \left( \theta _{
\mathbf{R}}\right) \right) e^{im\phi _{\mathbf{R}}}{\cal F}_{l}\left( \beta ,\left| \mathbf{R}\right| \right)
\nonumber\\
 & + & {\cal C}_2 \sum _{\mathbf{G}\neq \left\{ \emptyset \right\} }\, \int _{-\infty }^{\infty }
\: dG_{z}\: \left| \mathbf{G}
\right| ^{l-2}e^{-\frac{\pi ^{2}\left| \mathbf{G}\right| ^{2}}{\beta ^{2}}}\, 
\nonumber\\
&& \qquad \qquad \qquad \qquad  {\tilde P}_{l}^{m}
\left( \cos \left( \theta _{\mathbf{G}}\right) \right) e^{im\phi _{\mathbf{G}}}
\nonumber\\
\label{C10}
\end{eqnarray}
%
where,
\begin{eqnarray}
{\cal C}_1 = \frac{4\pi ^{\frac{3}{2}}(\frac{i}{2})^{l}}{V_{cell}\Gamma \left( l+\frac{1}{2}\right) }
\nonumber\\
{\cal C}_2 =  \frac{4\pi ^{\frac{3}{2}}(\frac{i}{2})^{l}}{A_{cell}\Gamma \left( l+\frac{1}{2}\right) }
\label{C10p}
\end{eqnarray}
and \( A_{cell} \) is the area of the cell along the non-periodic
direction. We have found that we can obtain the \( {\cal M} \) tensor
matrix elements to 8-10 digits of accuracy with this technique.


\section{Thresholds}\label{Thresholds}

There are four thresholds that control the numerical precision of the linear scaling algorithms
in {\sc MondoSCF}.  They are the matrix threshold $\tau_{\rm \scriptscriptstyle MTRIX}$
described in Ref.~[\onlinecite{ANiklasson03}], the two-electron threshold  $\tau_{\rm \scriptscriptstyle 2E}$ ({\tt thresh} in Ref.~[\onlinecite{ESchwegler97}]),
the distribution threshold   $\tau_{\rm \scriptscriptstyle DIST}$ described in Ref.~[\onlinecite{CTymczak04A}],
and the HiCu threshold $\tau_{\rm \scriptscriptstyle HICU}$ used to set the exchange-correlation grid ($\tau_r$ in 
Ref.~[\onlinecite{MChallacombe00A}]).  The threshold $\tau_{\rm \scriptscriptstyle 2E}$ also controls accuracy of the
Coulomb matrix as discussed in Ref.~[\onlinecite{CTymczak04A}].
These thresholds, listed in Table~\ref{Table:AccurLevels},  have been 
calibrated over a wide range of systems to yield a minimum of  4, 6 and 8 digits of relative accuracy in the total 
energy with {\tt LOOSE}, {\tt GOOD} and {\tt TIGHT} respectively.    Typically however, one additional digit is achieved for 
models that contain Hartree-Fock exchange.

\begin{table}[h]
\caption{Accuracy goals and corresponding thresholds that control precision of the {\sc MondoSCF} linear scaling algorithms.}
\label{Table:AccurLevels}
\center{
\begin{tabular}{lllll}
\toprule
Accuracy        &  $\tau_{\rm \scriptscriptstyle MTRIX} $ & $\tau_{\rm \scriptscriptstyle 2E}$ & $\tau_{\rm \scriptscriptstyle DIST}$ & $\tau_{\rm \scriptscriptstyle HICU}$ \\ 
\colrule
{\tt LOOSE}     & $10^{-4}$ & $10^{-6}$  & $10^{-8}$  & $10^{-3}$ \\
{\tt GOOD}      & $10^{-5}$ & $10^{-8}$  & $10^{-10}$ & $10^{-5}$ \\
{\tt TIGHT}     & $10^{-6}$ & $10^{-10}$ & $10^{-12}$ & $10^{-7}$ \\
\botrule
\end{tabular}}
\end{table}


%\section{Coordinates of Validation Suite}\label{FracCoords}
%
%\begin{table}[h]
%\caption{Fractional coordinates for the Triclinic 2 atom unit cell of NaCl, corresponding to the 
%         calculations reported in Tables~\ref{NaCl8511} and \ref{NaClGammaPt}.  Length of the unit cell is 
%         $a=b=c=3.97394011$\AA, with angles $\alpha=\beta=\gamma=60^\circ$.}
%\center{
%\begin{tabular}{cccc}
%\toprule
% Atom &  X  & Y  & Z \\
%\colrule
%Na &    0.000 &  0.000 &  0.000  \\
%Cl &    0.500 &  0.500 &  0.500  \\
%\botrule
%\end{tabular}}
%\end{table}
%
%
%
%\begin{table}[h]
%\caption{Fractional coordinates for the Triclinic 2 atom unit cell of MgO, corresponding to the 
%         calculations reported in Tables~\ref{NaCl8511}-\ref{NaClGammaPt}.  Length of the unit cell is 
%         $a=b=c=2.977776807$\AA, with angles $\alpha=\beta=\gamma=60^\circ$.}
%\center{
%\begin{tabular}{cccc}
%\toprule
% Atom &  X  & Y  & Z \\
%\colrule
%O  &    0.000 &   0.000 &  0.000  \\
%Mg &    0.500 &   0.500 &  0.500  \\
%\botrule
%\end{tabular}}
%\end{table}
%
%
%
%\begin{table}[h]
%\caption{Fractional coordinates for the 8 atom unit cell of Diamond, corresponding to the supercell calculations
%         reported in Table~\ref{DiamondGammaPt}.  Dimensions of the cubic unit cell are $a=b=c=3.5700$\AA.}
%\center{
%\begin{tabular}{cccc}
%\toprule
% Atom &  X  & Y  & Z \\
%\colrule
%C &     0.125 &    0.125 &    0.125  \\
%C &     0.375 &    0.375 &    0.375  \\
%C &     0.625 &    0.625 &    0.125  \\
%C &     0.875 &    0.875 &    0.375  \\
%C &     0.625 &    0.125 &    0.625  \\
%C &     0.875 &    0.375 &    0.875  \\
%C &     0.125 &    0.625 &    0.625  \\
%C &     0.375 &    0.875 &    0.875  \\
%\botrule
%\end{tabular}}
%
%
%

\end{document}
