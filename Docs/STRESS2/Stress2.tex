%
%   This file is part of the APS files in the REVTeX 4 distribution.
%   Version 4.0 of REVTeX, August 2001
%
%   Copyright (c) 2001 The American Physical Society.
%
%   See the REVTeX 4 README file for restrictions and more information.
%
% TeX'ing this file requires that you have AMS-LaTeX 2.0 installed
% as well as the rest of the prerequisites for REVTeX 4.0
%
% See the REVTeX 4 README file
% It also requires running BibTeX. The commands are as follows:
%
%  1)  latex apssamp.tex
%  2)  bibtex apssamp
%  3)  latex apssamp.tex
%  4)  latex apssamp.tex
%
%\documentclass[prb,aps,nobibnotes,twocolumn,doublespace,twocolumngrid,superbib]{revtex4}
%%\documentclass[twocolumn,showpacs,preprintnumbers,amsmath,amssymb]{revtex4}
%\documentclass[preprint,showpacs,preprintnumbers,amsmath,amssymb]{revtex4}

% Some other (several out of many) possibilities
%\documentclass[preprint,aps]{revtex4}
%\documentclass[preprint,aps,draft]{revtex4}
%\documentclass[prb]{revtex4}% Physical Review B

%%\usepackage{amsmath}
%%\usepackage{amssymb}
%%\usepackage{graphicx}% Include figure files
%%\usepackage{dcolumn}% Align table columns on decimal point
%%\usepackage{bm}% bold math

%\documentclass[pre,aps,twocolumn,showpacs,twocolumngrid,superbib]{revtex4}
%\documentclass[prl,aps,twocolumn,showkeys,twocolumngrid,superbib]{revtex4}
%\documentclass[twocolumn,showkeys,showpacs,preprintnumbers,amsmath,amssymb]{revtex4}
\documentclass[pra,twocolumn,showpacs,twocolumngrid,superbib]{revtex4}
%\documentclass[showpacs,preprint,superbib]{revtex4}

\usepackage{graphicx}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{alltt}
\usepackage{fancyhdr}
\usepackage{dcolumn} 

\pagestyle{fancy}


\def\Tr{{\rm Tr}}

%\nofiles

\begin{document}

%\preprint{APS/123-QED}

%\title{Density functional energy gradients with respect to atomic positions and cell parameters
%  within the $\Gamma$-point approximation}
\title{Energy gradients with respect to atomic positions and cell parameters
  for the density functional theory at the $\Gamma$-point}

\author{Val\'ery Weber}
\affiliation{Department of Chemistry, University of Fribourg, 1700 Fribourg, Switzerland.}%
\author{Christopher J. Tymczak}%
\email{tymczak@lanl.gov}
\author{Matt Challacombe}%
\affiliation{Los Alamos National Laboratory, Theoretical Division, Los Alamos 87545, New Mexico, USA.}%

\date{\today}% It is always \today, today,
             %  but any date may be explicitly specified

\begin{abstract}
  The application of theoretical methods based on Density Functional Theory
  is known to provide geometrical and cell parameters in very good agreement
  with experimental values. Recently, construction of the exact Hartree-Fock exchange
  gradients with respect to atomic positions and cell parameters
  within the $\Gamma$-point approximation
  has been introduced [J. Chem. Phys. {\bf ???}, ????, (2006)].
  In this article, the formalism is extended to the evaluation of
  analytical $\Gamma$-point density functional energy atomic and cell gradients. 
  As an illustration, the analytical gradients have been used
  in conjunction with the QUICCA algorithm [K. N\'emeth and M. Challacombe,
  J. Chem. Phys. {\bf 121}, 2877, (2004)] to optimize 1D and 3D periodic
  systems at the DFT and hybride-HF/DFT levels.
\end{abstract}

%\pacs{Valid PACS appear here}% PACS, the Physics and Astronomy
                             % Classification Scheme.
\keywords{Periodic boundary condition, density functional theory, cell gradients, $\Gamma$-point.}
                              %display desired
\maketitle

%\section{Don't forget to change that}
%-Add KDoll01a in mondo.bib K. Doll Computer Physics Communications 137 (2001) 74-88\\
%-See that http://www.cryst.ehu.es/\\

\section{Introduction}
In preceding papers, we have developed linear scaling quantum chemical methods
for construction of the periodic Coulomb, exchange-correlation~\cite{CTymczak04a}
and the exact Hartree-Fock exchange~\cite{CTymczak04b}
matrices within the $\Gamma$-point approximation.
In this paper, the implementation of the Coulomb and exchange-correlation 
energy gradients with respect to atomic positions and cell parameters
at the $\Gamma$-point is presented.

Kohn-Sham density functional theory has proven to be a highly 
competitive method for a wide range of applications in solid 
state physics and chemistry.
The hybrid Hartree-Fock/Density Functional Theory (hybrid-HF/DFT) model chemistries
are an important next step in accuracy beyond the Generalized Gradient
Approximation~\cite{Gill92,Becke93,VBarone96,CAdamo99}. 

%Together with linear
%scaling methods for computing the density matrix~\cite{ANiklasson02A,ANiklasson03}, these
%advances provide a framework for the application of hybride-HF/DFT
%models to large condensed phase systems, polymers, surfaces and wires.

While the $\Gamma$-point approximation uses only the $\mathbf{k}=0$ point to sample
the Brillouin zone, it does however converge to the
${\bf k}$-space integration limit, in the worst case with the inverse
unit cell volume (see for example Refs.~\cite{CKittel71,NAshcroft76}).
The convergence of the $\Gamma$-point approximation to
the corresponding ${\bf k}$-space limit was recently
demonstrated by us for DFT~\cite{CTymczak04a}, HF and hybrid-HF/DFT~\cite{CTymczak04b} 
level of theories as well as for the Hartree-Fock 
atomic and cell gradients~\cite{VWeber05b}.

For one dimensional fluoric acid (HF)$_n$ chains, the convergence of the 
HF-MIC $\Gamma$-point energy, atomic and cell forces to the converged 
large cell $\Gamma$-point approximation with respect to cell length 
have been explicitly shown to be exponential in the cell size~\cite{VWeber05b}. 
A fast convergence of the total energy and geometrical parameters
have also been observed for 1D and 3D systems as MgO and urea.

The $\Gamma$-point approach opens the capabilities of studying very large
complex and disordered systems such as liquids, low concentration defects, adsorption of
large molecule on surfaces, {\em etc}, where conventional methods
of sampling the Brillouin zone may become computationally too demanding, and
where the $\Gamma$-point approximation is well justified.

Finding crystal structures of condensed systems can
be formulated as a minimization of the total energy
with respect to atomic coordinates and cell vectors.
The problem is then the minimization of the total energy with $L$ degree of freedom, where
$L=3N_{atm}+3$, $N_{atm}$ is the number of atoms, $3N_{atm}-3$ is the number
of independent coordinates after the elimination of translation,
and the number of independent vector elements
after the elimination of cell rotations is 6.

This minimization can be achieved with the help of an 
efficient optimizer~\cite{KNemeth04,TBucko05,KNemeth05}
and the knowledge of the gradients with respect to atomic 
positions and cell parameters.

The analytical cell gradient method of density functional theory using GTAO for
one dimensional extended systems was implemented by Hirata and Iwata~\cite{SHirata98}.
The three dimensional case has been implemented by Kudin and Scuseria
~\cite{KKudin00A,KKudin00B}. Their approach for the Coulomb problem is
based on the direct space fast multipole method.
Recently Doll, Dovesi and Orlando~\cite{KDoll04} presented
implementation of the Hartree-Fock cell gradients~\cite{RDovesi00} in
the {\sc Crystal03}~\cite{Crystal03} package for three dimensional systems.
Their code is based on GTAO and the summation
of the Coulomb energy is performed with the Ewald method~\cite{PEwald21},
which is a combination of direct and reciprocal cell summations.
%For an efficient truncation of the three infinite summations of the exchange
%series, the {\sc Crystal03} program uses in the first hand, the decay between local basis function
%products and in the second, the fact that elements of the density
%matrix of an insulator decays exponentially with inter-atomic separations.
The strategy to compute the analytic Hartree-Fock gradients for
periodic system, in the frame of the {\sc Crystal03} package has been
presented by Doll, Saunders and Harrison~\cite{KDoll01} and Doll \cite{KDoll01a}.
Their implementation is based on the Hermite Gaussian-type functions
in the context of the McMurchie-Davidson algorithm~\cite{LMcmurchie78}.

The remainder of this paper is organized as follows:
In Section~\ref{Sec:Formalism}, we introduce the formalism and discuss
the implementation of the Coulomb and exchange-correlation gradients with respect
to atomic positions and cell parameters
at the $\Gamma$-point approximation. Full optimization of several 3D
periodic systems are given
in Section~\ref{Sec:NumExamples} as an illustration of the formalism.
Finally in Section~\ref{Sec:Conclusions} we summarize our results.

\section{Formalism}\label{Sec:Formalism}
The primitive cell is given by the three vectors $\mathbf{a}$,
$\mathbf{b}$ and $\mathbf{c}$. Then $M$ is the $3\times3$ matrix composed
of the primitive cell vectors
\begin{equation*}
  M=(\mathbf{a},\mathbf{b},\mathbf{c}).
\end{equation*}
The position of a cell is $\mathbf{R(n)}=M\mathbf{n}$,
with $\mathbf{n}=(n_a,n_b,n_c)$ a vector of integers.
The position of atom $A$ in the cell $\mathbf{R(n)}$ is $\mathbf{A}=M(\mathbf{f}_A+\mathbf{n})$,
with $\mathbf{f}_A=(f_{Aa},f_{Ab},f_{Ac})$ the fractional coordinates of
atom $A$ in the central cell.

An unnormalized Cartesian Gaussian-type function (CGTF) centered on atom $A$ is
\begin{equation*}
  \phi_a(\mathbf{r})=(x-A_x)^{a_x}(y-A_y)^{a_y}(z-A_z)^{a_z}e^{-\zeta_a(\mathbf{r-A})^2},
\end{equation*}
where the triad $a=(a_x,a_y,a_z)$ sets the angular symmetry and the exponent $\zeta_a$
is chosen to describe a particular length scale. Gaussian basis functions are often
contracted to approximate atomic eigenfunctions.

The total energy within the $\Gamma$-point approximation~\cite{CTymczak04a,CTymczak04b} can be 
expressed as:
\begin{equation}\label{Eq:TotE}
  \begin{split}
%%%%%%%%%%%%%%%%%%%%%%%%
    E_{tot}(&\mathbf{f}_A,\mathbf{f}_B,\ldots,M)=\sum_{ab} P_{ab}
    [T_{ab}+\frac{1}{2}(J_{ab}+\alpha_1 K_{ab})]\\
    &+\alpha_2 E^{xc}+h_{nuc},
%%%%%%%%%%%%%%%%%%%%%%%%
%    E_{tot}(\mathbf{f}_A,&\mathbf{f}_B,\ldots,M)=E^{k}+E^{c}+\alpha_1 E^{x}+\alpha_2 E^{xc}\\
%    &=\sum_{ab} P_{ab}[T_{ab}+\frac{1}{2}(J_{ab}+\alpha_1 K_{ab})]\\
%    &+\alpha_2 E^{xc}+h_{nuc},
%%%%%%%%%%%%%%%%%%%%%%%%
%%    E_{tot}(\mathbf{f}_A,\mathbf{f}_B,\ldots,M)=E^{kin}+E^{C}+E^{x}+E^{xc},
%    E_{tot}(\mathbf{f}_A,\mathbf{f}_B,\ldots,M)&=\Tr[PT]+h_{nuc}\\
%    &+\frac{1}{2} \Tr [P(J+\alpha_1 K^{xc}+\alpha_2 K)]
%%    &+\frac{1}{2}\sum_{ab} P_{ab}[J_{ab}+\alpha_1 K_{ab}^{xc}+\alpha_2 K_{ab}]+h_{nuc},
%    E(&\mathbf{f}_A,\mathbf{f}_B,\ldots,M)=
%    \sum_{\substack{\mathbf{m}\\a b}}P_{ab}((a|T|b^\mathbf{m})\\
%    &+\frac{1}{2}\sum_{\substack{\mathbf{m}\mathbf{n}\\a b c d}}P_{ab}P_{cd}( (ab|c^\mathbf{m}d^\mathbf{n})
%    -\frac{1}{2}(ac^\mathbf{m}|bd^\mathbf{n}) )+E_{nuc}
  \end{split}
\end{equation}
%where the different contributions are given
%\begin{equation}
%  \begin{split}
%    E^{kin}&=\sum_{ab}P_{ab}T_{ab}\\
%    E^{C}&=\frac{1}{2}\sum_{ab}P_{ab}J_{ab}\\
%    E^{x}&=\frac{1}{2}\sum_{ab}P_{ab}K^{x}_{ab}\\
%    E^{xc}&=,
%  \end{split}
%\end{equation}
%where $P$, $T$, $J$, $K^{xc}$ and $K$ 
%are respectively the density, kinetic energy, electron-electron and elecetron-nuclear Coulomb,
%exchange-correlation, exacte Hartree-Fock exchange matrices.
%and $h_{nuc}$ is the nuclear-nuclear repulsion energy.
where $P$ is the density matrix, $T$ is the kinetic energy matrix, $J$
is the electron-electron and electron-nuclear Coulomb matrix, 
$E^{xc}$ the exchange-correlation energy, $K$ is the exacte 
Hartree-Fock exchange matrix and $h_{nuc}$ is the nuclear-nuclear repulsion energy.
The factors $\alpha_1$ and $\alpha_2$ are mixing coefficients of the
exacte Hartree-Fock and exchange-correlation energies respectively.

%within the $\Gamma$-point approximation~\cite{CTymczak04a,CTymczak04b}
%where the indices $\mathbf{mn}$ run over the direct lattice vectors,
%$abcd$ over the basis functions,

%and the ERIs are written in the Mulliken notation and computed
%with the MIC as discussed in the following.

The derivative of the total energy Eq.~\ref{Eq:TotE} with respect to a general external perturbation $\lambda$ is 
\begin{equation*}
  \begin{split}
%%%   \frac{\partial E_{tot}}{\partial \lambda}&=\frac{\partial E^{kin}}{\partial \lambda}
%%% -\sum_{ab}W_{ab}\frac{\partial S_{ab}}{\partial \lambda}+\frac{\partial h_{nuc}}{\partial \lambda}\\
%%%   &+\frac{1}{2}\bigg[\frac{\partial E^{C}}{\partial \lambda}\bigg|_P
%%%    +\alpha_1 \frac{\partial E^{x}}{\partial \lambda}\bigg|_P\bigg]
%%%    +\alpha_2 \frac{\partial E^{xc}}{\partial \lambda}\bigg|_P
    \frac{\partial E_{tot}}{\partial\lambda}&=
%    \frac{\partial E^{k}}{\partial\lambda}+\frac{\partial E^{c}}{\partial\lambda}+
%    \frac{\partial E^{x}}{\partial\lambda}+\frac{\partial E^{xc}}{\partial\lambda}\\
    \sum_{ab}P_{ab}\frac{\partial T_{ab}}{\partial\lambda}
    +\frac{\partial h_{nuc}}{\partial\lambda}\\
    &+\frac{1}{2}\sum_{ab}P_{ab}\bigg[\frac{\partial J_{ab}}{\partial\lambda}\bigg|_P
     +\alpha_1 \frac{\partial K_{ab}}{\partial\lambda}\bigg|_P\bigg]\\
    &+\alpha_2 \frac{\partial E^{xc}}{\partial\lambda}\bigg|_P
    -\sum_{ab}W_{ab}\frac{\partial S_{ab}}{\partial\lambda}
%    &+\alpha_2 E^{xc}+h_{nuc},
%    \frac{\partial E_{tot}}{\partial \lambda}&=2\Tr\left[PFP\frac{\partial S}{\partial \lambda}\right]
%    +\frac{\partial h_{nuc}}{\partial \lambda}\\
%    &-\Tr\left[P\frac{\partial J}{\partial \lambda}\bigg|_P+\alpha_1 P\frac{\partial K^{xc}}{\partial \lambda}\bigg|_P+\alpha_2 
%      P\frac{\partial K}{\partial \lambda}\bigg|_P\right]
%    E(\mathbf{f}_A,\mathbf{f}_B,\ldots,M)=\sum_{a b}P_{ab}(h_{ab}+J_{ab}+K_{ab}^{xc}+K_{ab})+E_{nuc}
%    -\frac{1}{2}\sum_{\substack{\mathbf{m}\\a b}}P_{ab}((a|\nabla^2|b^\mathbf{m})-\sum_A Z_A(a|1/|r-A||b^\mathbf{m}) )\\
%    &+\sum_{\substack{\mathbf{m}\mathbf{n}\\a b c d}}P_{ab}P_{cd}( (ab|c^\mathbf{m}d^\mathbf{n})
%    -\frac{1}{2}(ac^\mathbf{m}|bd^\mathbf{n}) )+E_{nuc}
  \end{split}
\end{equation*}
where $W=PFP$ is the energy-weighted density matrix and $F$ the Fockian.
The gradients with respect to fractional coordinates and cell parameters 
are simply given by $\lambda=f_{Gj}$ and $\lambda=M_{ij}$, respectively.
The Hartree-Fock exchange gradients with respect to atomic and cell parameters,
{\em i.e.} $\partial K_{ab}/\partial\lambda |_P$, have been previously derived~\cite{VWeber05b}.

The energy gradient with respect to the fractional coordinate
$f_{Gj}$ can be obtained through the linear transform
\begin{equation*}
  \frac{\partial E_{tot}}{\partial f_{Gj}}=\sum_{i=x,y,z}M_{ij}\frac{\partial E_{tot}}{\partial G_i},
\end{equation*}
where $\partial E_{tot}/\partial G_i$ is the standard gradient with respect to atomic position.
In the following, we describe the implementation of the Coulomb and exchange-correlation
gradients with respect to atomic and cell parameters.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Coulomb integrals}
\noindent The periodic quantum Coulomb sum involves the three contributions~\cite{CTymczak04a}
\begin{equation*}
J_{ab}=J_{ab}^{\rm In}+J_{ab}^{\rm PFF}+J_{ab}^{\rm TF},
\end{equation*}
where $J_{ab}^{\rm In}$ is the inner cell set sum evaluated by the 
Quantum Chemical Tree Code (QCTC)~\cite{MChallacombe97}, $J_{ab}^{\rm PFF}$ is the 
periodic far field term and $J_{ab}^{\rm TF}$ is a surface term which corrects 
the boundary at infinity.
\subsubsection{Inner Sum}
\noindent The inner cell set contribution to the Coulomb matrix is 
\begin{equation*}
J_{ab}^{\rm In} = \sum_{{\bf R'} \in {\rm In}} \iint \rho_{ab}({\bf r}) | 
{\bf r}-{\bf r'}+{\bf R'}|^{-1} \rho_{tot}({\bf r'}) dVdV'\,,
\end{equation*}
where
\begin{eqnarray*}
\rho_{ab}({\bf r})  & = & \sum_{\bf R} \phi_a({\bf r}) \phi_b({\bf r}+{\bf R}),\\
\rho_{tot}({\bf r}) & = & \sum_{ab} P_{ab} \rho_{ab}({\bf r}) -\sum_{A} Z_A \delta({\bf r}-{\bf A}),
\end{eqnarray*}
$Z_A$ is the charge of atom $A$ and $\delta({\bf r})$ is the Dirac delta function.
The derivative of $J_{ab}^{\rm In}$, at $P$ constant, with respect to the cell parameter $M_{ij}$ is
\begin{equation*}
  \begin{split}
{{\partial J_{ab}^{\rm In}} \over {\partial M_{ij}}}\bigg|_P &= \sum_{{\bf R'} \in {\rm In}} 2\iint  
{{\partial \rho_{ab}({\bf r})}\over {\partial M_{ij}} } | 
{\bf r}-{\bf r'}+{\bf R'}|^{-1} \rho_{tot}({\bf r'}) dVdV'\\
&+ \iint \rho_{ab}({\bf r})
{{\partial |{\bf r}-{\bf r'}+{\bf R'}|^{-1}} \over {\partial M_{ij}}} \rho_{tot}({\bf r'})dVdV'.
  \end{split}
\end{equation*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Periodic far field}
\noindent We use a spherical multipole method in order to compute the periodic far field correction to the 
Coulomb matrix~\cite{CTymczak04a}, which is 
\begin{equation*}
J_{ab}^{\rm PFF}=\sum_{lml'm'} (-1)^l \rho^{lm}_{ab} {\cal M}_{l+l'}^{m+m'}  \rho^{l'm'}_{tot}
\end{equation*}
where the spherical densities $\rho^{lm}_{ab}$ and $\rho^{lm}_{tot}$ are obtained
by projecting  $\rho_{ab}({\bf r})$ and $\rho_{tot}({\bf r})$, respectively, onto the regular spherical 
harmonics $O_{lm}({\bf r})$ as
\begin{eqnarray*}
\rho^{lm}_{ab}  & = & \int \rho_{ab}( {\bf r}) O_{lm}({\bf r})dV \textrm{ and}\\
\rho^{lm}_{tot} & = & \int \rho_{tot}({\bf r}) O_{lm}({\bf r})dV. 
\end{eqnarray*}
The derivative of $J_{ab}^{\rm PFF}$, at $P$ constant, with respect to the cell parameter $M_{ij}$ is
\begin{equation*}
  \begin{split}
{{\partial J_{ab}^{\rm PFF}} \over {\partial M_{ij}}}\bigg|_P &= \sum_{lml'm'}
2 (-1)^l {{\partial \rho^{lm}_{ab}} \over {\partial M_{ij}}} {\cal M}_{l+l'}^{m+m'} \rho^{l'm'}_{tot}\\
&+ (-1)^l \rho^{lm}_{ab} {{\partial {\cal M}_{l+l'}^{m+m'}}\over {\partial M_{ij}} } \rho^{l'm'}_{tot}
  \end{split}
\end{equation*}
where the calculation of $\partial {\cal M}_l^m/\partial M_{ij}$ is straitforward but tedious
and is shown in the Appendix~\ref{Apx:MDer}. for completness.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Tin-Foil}
\noindent The tin-foil correction to the Coulomb matrix is
\begin{equation*}
J_{ab}^{\rm TF}=\frac{2\pi}{3V_{uc}}(QS_{ab}-2\mathbf{d}_{ab}\cdot\mathbf{D})
\end{equation*}
where $Q$ is the trace of the system quadrupole, $S_{ab}$ is an element of the overlap matrix,
$\mathbf{D}$ the dipole moment of the system,
$\mathbf{d}_{ab}$ the dipole moment of the distribution $\rho_{ab}$.
The derivative of $J_{ab}^{\rm TF}$ with respect to the cell parameter $M_{ij}$ is
\begin{equation*}
  \begin{split}
    \frac{\partial J_{ab}^{\rm TF}}{\partial M_{ij}}\bigg|_P&=
    -\frac{2\pi}{3V_{uc}^2}\frac{\partial V_{uc}}{\partial M_{ij}}(QS_{ab}-2\mathbf{d}_{ab}\cdot\mathbf{D})\\
    &+\frac{2\pi}{3V_{uc}}\bigg(\frac{\partial Q}{\partial M_{ij}}\bigg|_P S_{ab}+Q\frac{\partial S_{ab}}{\partial M_{ij}}\\
    &-2\frac{\partial \mathbf{d}_{ab}}{\partial M_{ij}}\cdot\mathbf{D}
    -2\mathbf{d}_{ab}\cdot\frac{\partial \mathbf{D}}{\partial M_{ij}}\bigg|_P \bigg),
  \end{split}
\end{equation*}
where the derivatives ${\partial Q}/{\partial M_{ij}}|_P$,
${\partial \mathbf{d}_{ab}}/{\partial M_{ij}}$ and
${\partial \mathbf{D}}/{\partial M_{ij}}|_P$ are straitforward;
the terms ${\partial S_{ab}}/{\partial M_{ij}}$ and ${\partial V_{uc}}/{\partial M_{ij}}$ 
are given in Ref.~\cite{KDoll04}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Exchange-correlation integrals}
The numerical integration of the DFT
exchange-correlation term is carried out over a cuboid
integration domain $V_{\Box}$ which is equivalent to the unit
cell volume $V_{uc}$. The exchange-correlation energy is thus
\begin{equation}\label{Eq:xc}
%  K_{ab}^{xc}=\int_{V_\Box}\rho_{ab}(\mathbf{r})v_{xc}[\rho,\mathbf{r}]d^3r.
%%  K_{ab}^{xc}=\int_{V_\Box}\rho_{ab}(\mathbf{r})v_{xc}(\rho,\mathbf{r})dV
%%  =\int_{V_\Box}f_{ab}(\mathbf{r})dV,
  E^{xc}%=\int_{V_\Box}\rho(\mathbf{r})\varepsilon_{xc}(\rho)dV
  =\int_{V_\Box}\rho(\mathbf{r})\varepsilon^{xc}(\rho(\mathbf{r}))dV
  =\int_{V_\Box}f(\mathbf{r})dV,
\end{equation}
where $\rho(\mathbf{r})=\sum_{ab}P_{ab}\sum_{\bf RR'}\phi_a({\bf r+R})\phi_b({\bf r+R'})$ is the
electronic density associated with $V_{uc}$.
%where $v_{xc}$ is the exchange-correlation potentiel.
In the following, the subscript $\Box$ will always refer to the cuboid cell.
This simple integration volume should be contrasted with more
conventional methods for computing the exchange-correlation matrix, involving
the ``Becke weights''~\cite{ABecke88}, which requirs integration over all the space $V_\infty$.
While Eq.~\ref{Eq:xc} is written in an abstract form for simplicity, 
in practice the code relies on the Pople, Gill and Johnson 
approach~\cite{JPople92,MChallacombe00A}. 

The derivative of Eq.~\ref{Eq:xc} with respect to cell parameter $M_{ij}$ at $P$ constant is given by
\begin{equation}\label{Eq:xcLatGrd}
  \begin{split}
    \frac{\partial E^{xc}}{\partial M_{ij}}\bigg|_P&=
%    \int_{V_{\Box}}\frac{\partial}{\partial M_{ij}}(\rho_{ab}(\mathbf{r})v_{xc}[\rho,\mathbf{r}])dV\\
%    &+\delta_{ij}\int_{S_{j}}\rho_{ab}(\mathbf{r})v_{xc}[\rho,\mathbf{r}]dS
    \int_{V_{\Box}}\frac{\partial f(\mathbf{r})}{\partial M_{ij}}\bigg|_PdV
%    \sum_{A}(f_{Aj}+n_j)\int_{V_{\Box}}\frac{\partial f(\mathbf{r})}{\partial A_i}dV\\
    +\delta_{ij}\int_{S_{j\Box}}f(\mathbf{r})dS.
  \end{split}
\end{equation}
%where the intergation over the surface $S_{j\Box}$ arises
%from the derivative of the limits of the integral~(\ref{Eq:xc}).
%where $S_{j\Box}$ is the surface defined by the two lattice vectors different than $j$. 
The derivative $\partial f(\mathbf{r})/\partial M_{ij}|_P$ can be further simplified as
\begin{equation*}
\frac{\partial f(\mathbf{r})}{\partial M_{ij}}\bigg|_P=\sum_{A,\mathbf{n}}
     (f_{Aj}+n_j)\frac{\partial f(\mathbf{r})}{\partial A_{i}}\bigg|_P,
\end{equation*}
where $\partial f(\mathbf{r})/\partial A_{i}|_P$ is obtained during the evaluation of the atomic gradients.
The surface integral (rightmost term in Eq.~\ref{Eq:xcLatGrd}), which is not present in 
previous derivations~\cite{MTobita03,KKudin00B}, has its origin in 
the derivative of the limits of the integral in Eq.~\ref{Eq:xc}.
%%%% Need to check SHirata97
%Similar surface integral can be obtained from the derivative with respect to 
%unit cell parameters of the grid weight encountered in methods based 
%on Becke’s original numerical quadrature scheme~\cite{MTobita03,SHirata97}.
The surface integral is approximated by 
\begin{equation*}%\label{Eq:xcLatGrd}
  \int_{S_{j\Box}}f(\mathbf{r})dS=%\approx 
%  \frac{1}{2h}\int_{-h}^h\int_{S_{j\Box}}f_{ab}(\mathbf{r})dSdw_j
  \frac{1}{2h}\int_{V_{j\Box}}f(\mathbf{r})dV+\mathcal{O}(h^2)
%  \int_{S_{j}}\rho_{ab}(\mathbf{r})v_{xc}[\rho,\mathbf{r}]dS\approx 
%  \frac{1}{2h}\int_{V_{j}}\rho_{ab}(\mathbf{r})v_{xc}[\rho,\mathbf{r}]dV
\end{equation*}
where $h$ is a small number (typically $10^{-4}\,a.u.$) and 
$V_{j\Box}=S_{j\Box}\times[-h,h]$ is a thin volume where the integration over the interval $[-h,h]$
is carried out along the normal to the surface $S_{j\Box}$. This simple domain, {\em i.e.} $V_{j\Box}$, 
can be efficiently integrated with the help of the HiCu algorithm~\cite{MChallacombe00A} 
to a desired accuracy.

\section{Numerical Examples}\label{Sec:NumExamples}
All developments were implemented in the {\sc MondoSCF}~\cite{MondoSCF} suite of
linear scaling quantum chemistry programs. 
%The code was compiled using the Portland Group F90 compiler {\tt pgf90} v5.1~\cite{pgf90-v5.1} 
%with the~{\tt -O1} options and with the GNU C compiler {\tt gcc} 
%v3.2.2 using the~{\tt -O1} flag.
The code was compiled using the HP fortran compiler {\tt f95} 
v5.5A~\cite{f95-v5.5a} and the {\tt -O4} option and the Compaq 
C compiler {\tt cc} v6.5~\cite{cc-v6.5} and the {\tt -O1} flag.
%All calculations were carried out on a 1024-node (2048 processors)
%dual P4 LinuxBIOS/BProc cluster connected with Myrinet 2000 running
%Red-Hat Linux release~9 (Shrike)~\cite{RedHat90}.
All calculations were carried out on a cluster of 256 4-CPU HP/Compaq 
Alphaserver ES45s with the Quadrics QsNet High Speed Interconnect.

The {\tt TIGHT} level of numerical accuracy has been used throughout this work.  
Thresholds that define the {\tt TIGHT} accuracy level include a matrix 
threshold $\tau=10^{-6}$, as well as other numerical thresholds 
detailed in Ref.~\cite{CTymczak04a}, which deliver at least 8 digits of 
relative accuracy in the total energy and 4 digits of absolute accuracy 
in the forces. 

In order to demonstrate the capabilities of our implementation of the
Khon-Sham density functional energy atomic and cell gradients, we present in this Section
full optimization studies of 1D and 3D periodic systems without any cell
or atomic positions symmetry constraint.
Our first benchmark case is the optimization of 1D polytetrafluoroethylene (CF$_2$)$_{2n}$
at the Perdew-Wang~\cite{JPerdew92} level of theory. The PW91 functional has been obtained from the
the Density Functional Repository~\cite{DFRepository}.
The second benchmark is MgO and was optimized at the Perdew-Burke-Ernzerhof (PBE)~\cite{Perdew_96v77} 
and Becke 3-parameter Lee-Yang-Parr (B3LYP)~\cite{ABecke93} 
level of theories. Finally, magnesium orthosilicate (Mg$_2$SiO$_4$, forsterite) 
was optimized at the B3LYP~\cite{ABecke93,Stephens94} level of theory. 

Table~\ref{Tab:PFE} shows the progression of the cell parameters $a_0$, bond lengths (C$-$C and C$-$F),
bond angle (F$-$C$-$F) and
total energies $E$ computed for polytetrafluoroethylene (CF$_2$)$_{2n}$ at
the $\Gamma$-point PW91 with the split-valence 6-31G** basis set.
Comparisons are made to cell parameter, bond length and bond angle values obtained
with the {\sc Crystal03}~\cite{Crystal03} package and a 12 $k$-points net at the
PW91/6-31G** level of theory.
While the atomic and cell parameters for polytetrafluoroethylene 
agree perfectly between the $k$-space integration
and the $\Gamma$-point approximation, the energies do not.
The reason for this disagreement can be found in the different atomic basis set used.
{\sc Crystal03} uses spherical harmonics d-shells consisting of 5 atomic orbitals
while {\sc MondoSCF} employs pure Cartesian basis functions {\em i.e.}~6 atomic orbitals
per Cartesian d-shells.

\begin{table}[t]
  \centering
  \caption{\protect
    Progression of the cell parameter $a_0$, bond lengths (C$-$C and C$-$F), 
    bond angle (F$-$C$-$F) and total energy $E$ 
    for polytetrafluoroethylene (CF$_2$)$_{2n}$ using the periodic $\Gamma$-point
    PW91/6-31G** level of theory and the {\tt TIGHT} thresholds.
    Lengths, angles and energies are in \AA, degrees and atomic units respectively.
  }\label{Tab:PFE}
  \begin{tabular}{lrccccc}
  \toprule
  & $n$ & $a_0$ & CC & CF & FCF & $E/n$  \\
  \hline
% 1x1x1 tight 6-31G**
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A          3.400134      0.000039      0.000000      3.400134
%     1     -475.2616179572
% c-c 1.823 c-f 1.339 f-c-f 116.9
% 2x1x1 tight 6-31G**
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A          5.401972     -0.000081      0.000000      5.401972
%     1     -950.8368795328
% c-c 1.588 c-f 1.360 f-c-f 109.9
% 3x1x1 tight 6-31G**
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A          7.920249     -0.000125      0.000000      7.920249
%     1    -1426.2991245708
% 4x1x1 tight 6-31G**
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A         10.536676     -0.000143      0.000000     10.536676
%     1    -1901.7401759761
% 5x1x1 tight 6-31G**
% 6x1x1 tight 6-31G**
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A         15.795180      0.000374      0.000000     15.795180
%     1    -2852.6132167641
    {\sc MondoSCF}\footnote[1]{$\Gamma$-point.} 
    &    1 & 3.400 & 1.823 & 1.339 & 116.9 & $-$475.261618 \\%
    &    2 & 2.701 & 1.588 & 1.360 & 109.9 & $-$475.418440 \\%
    &    3 & 2.640 & 1.571 & 1.361 & 109.5 & $-$475.433042 \\%
    &    4 & 2.634 & 1.570 & 1.361 & 109.5 & $-$475.435044 \\%
%    &    5 &  &  &  &  & $-$ \\%
    &    6 & 2.632 & 1.570 & 1.361 & 109.5 & $-$475.435536 \\%
  \hline
    {\sc Crystal03}\footnote[2]{12 $k$-points.}
% Crystal Default 2.628  -4.754309452268E+02 c-c 1.570 c-f 1.360 c-c-c 113.7 f-c-f 109.5
    &    1 & 2.628 & 1.569 & 1.360 & 109.5 & $-$475.430945 \\
  \botrule
  \end{tabular}
\end{table}

Table~\ref{Tab:MgO} shows the progression of the cell parameters, total energies and
fractional coordinates of oxygen computed
for various cubic MgO supercells at the $\Gamma$-point PBE~\cite{Perdew_96v77}
and B3LYP~\cite{ABecke93} level of theories using
the 8-61G(Mg)/8-51G(O) basis sets.
The basis sets were specially optimized at the HF level for MgO by
Caus\`a et al~\cite{CBS:861G:MgO} and were obtained from Ref.~\cite{CrystalLib}.
The primitive cubic cell coordinates used for this system are given in
Ref.~\cite{PBCCoordinates}.
For comparison, we report the optimized cell parameter of cubic MgO
obtained with the {\sc Crystal03} code and a $8\times 8\times 8$ ${\bf k}$-points integration grid
as well as the experimental cell parameter~\cite{RWyckoff63}.
For both PBE and B3LYP, the smallest system (MgO)$_4$ 
shows a large discrepantcy of the cell parameter, energy and fractional 
coordinate of the oxygen with respect to its ${\bf k}$-space integration 
counterpart. The larger systems give cell parameter and 
fractional coordinate of the oxygen in very good agreement 
with the {\sc Crystal03} results; and the energies systematical converge 
while the system grows.
\begin{table}[t]
  \centering
  \caption{\protect
    Progression of the cell parameter $a_0$,
    total energy $E$ and fractional coordinate of the oxygen $f_O$ in the primitive cell 
    for cubic (MgO)$_n$ using the periodic $\Gamma$-point
    PBE/8-61G(Mg)/8-51G(O) and B3LYP/8-61G(Mg)/8-51G(O) level 
    of theories and the {\tt TIGHT} thresholds.
    Cell parameters and energies are in \AA~and atomic unit respectively.
  }\label{Tab:MgO}
  \begin{tabular}{lcrccc}
  \toprule
  & & $n$ & $a_0$ & $E/n$ & $f_O$ \\
  \hline
    {\sc MondoSCF}\footnote[1]{$\Gamma$-point.} 
    & PBE   &   4 & 4.331 & $-$275.243165 & 0.4998 \\%
    &       &  32 & 4.213 & $-$275.284428 & 0.5000 \\%
    &       & 108 & 4.212 & $-$275.284641 & 0.5000 \\%
    & B3LYP &   4 & 4.328 & $-$275.389093 & 0.4972 \\%VWN5
    &       &  32 & 4.204 & $-$275.431167 & 0.5000 \\%VWN5
    &       & 108 & 4.204 & $-$275.431343 & 0.5000 \\%VWN5
  \hline
    {\sc Crystal03}\footnote[2]{$8\times 8\times 8$ $\mathbf{k}$-points.}
    & PBE   &   1 & 4.212 & $-$275.284731 & $1/2$ \\
    & B3LYP &   1 & 4.204 & $-$275.431235 & $1/2$ \\
  \hline
    {Exp.}\footnote[3]{Experimental value~\cite{RWyckoff63}.}
    &       &   1 & 4.20  &               &  \\
%    {Exp.}\footnote[4]{Experimental value~\cite{SSinogeikin99,SSinogeikin00}.}
%    &       &   1 & 4.211 &               &  \\
%%%%
% Exp1.
%   S. V. Sinogeikin and J. D. Bass, Phys. Earth Planet. Inter. 120, 43 2000 
%   S. V. Sinogeikin and J. D. Bass, Phys. Rev. B 59, R14 141 1999
% Exp2.
%   R. W. G. Wyckoff 1963 Crystal Structure (New York: Wiley)
%%%%
  \botrule
  \end{tabular}
\end{table}
%
%MgO PBExc Crystal03 User2.bas 8x8x8 default
%4.200 -275.28468980590
%4.205 -275.28471572672
%4.208 -275.28472235701
%4.210 -275.28472911839
%4.211 -275.28473028612
%4.212 -275.28473081270 <<<
%4.213 -275.28473059552
%4.215 -275.28473044697
%4.250 -275.28445240627
%
%MgO B3LYP Crystal03 User2.bas 8x8x8 default
%4.190 -275.43120191268
%4.200 -275.43122829482
%4.202 -275.43123248175
%4.203 -275.43123398833
%4.204 -275.43123514068 <<<
%4.205 -275.43123509457
%4.210 -275.43123002554
%4.215 -275.43121357505
%4.220 -275.43118801547
%4.250 -275.43082055853
%
%MONDO PBExc User2.bas Tight
%   a     a0         E                  E/n          d       f
% 4.3307 4.3307  -1100.9726623928 -275.243165598200 2.1643  0.49976
% 8.4253 4.2126  -8809.1016996344 -275.284428113575 2.1065  0.50004
%12.6369 4.2123 -29730.7411945410 -275.284640690194 2.1062  0.50001
%
%MONDO B3LYP/VWN3 User2.bas Tight
% 4.3278 4.3278  -1101.8625722845 -275.465643071125 2.1518  0.49720
% 8.4070 4.2035  -8816.2479051094 -275.507747034669 2.1017  0.49999
%
%
%MONDO B3LYP/VWN5 User2.bas Tight
% 4.3278 4.3278  -1101.5563720224 -275.389093005600 2.1518  0.49720
% 8.4080 4.2040  -8813.7973326984 -275.431166646825 2.1020  0.50000
%12.6120 4.2040 -29746.5849x98447 -275.431342578215 2.1020  0.50000
%

In Table~\ref{Tab:Forsterite}, we present the optimization of forsterite at the 
%P. J. Stevens et al, J. Phys. Chem. 98, p.11623 (1994)
B3LYP/8-61G*(Mg)/88-31G*(Si)/8-51G*(O) $\Gamma$-point approximation.
The basis sets were obtained from Ref.~\cite{CrystalLib}.
For comparison, we report the optimized cell parameters of forsterite
obtained by Jochym, Parlinski and Krzywiec~\cite{PJochym04} with the {\sc Vasp}~\cite{Kresse96a,Kresse96b} 
code and a $3\times 3\times 3$ $\mathbf{k}$-points integration grid.
We also report the experimental cell parameters 
messured by Yoder and Sahama~\cite{HYoder57}.
%with the constraint $\alpha=\beta=\gamma=90^\circ$. 
%
% See:
% Merawa M, Noel Y, Civalleri B, Brown R, Dovesi R, Raman and infrared vibrational 
% frequencies and elastic properties of solid BaFCl calculated with various 
% Hamiltonians: an ab initio study, 
% J. Phys-Condens. Mat. 17, 535-548 (2005). 
%
% P. Baranek and J. Schamps, Influence of electronic correlation on structural, 
% dynamic and elastic properties of MgSi, 
% J. Phys. Chem. B 103, 2601-2606 (1999).
%
% A. Lichanot, E. Aprà and R. Dovesi, Quantum mechanical Hartree-Fock study of 
% the elastic properties of LiS and NaS, 
% Phys. Stat. Sol. (b) 177, 157-163 (1993). 
%
% A. Lichanot, M. Merawa and M. Causà, Density Functional LCAO calculation of 
% periodic systems. Effect of an ``a posteriori'' correction of the Hartree-Fock 
% energy on physical properties of ionic sulfur compounds, 
% Chem. Phys. Letters 246, 263-268 (1995). 
%
% Mian M, Harrison NM, Saunders VR, Flavell WR, An ab initio Hartree-Fock investigation 
% of galena (PbS), 
% Chem. Phys. Letters 257, 627-632 (1996). 
%
\begin{table}[t]
  \centering
  \caption{\protect
    Progression of the cell parameters $a_0$, $b_0$, $c_0$ and total energy $E$ 
    for (Mg$_2$SiO$_4$)$_n$ using the periodic $\Gamma$-point
    B3LYP/8-61G*(Mg)/88-31G*(Si)/8-51G*(O) level of theory and the {\tt GOOD} thresholds.
    The number $n=4,8,16,24$ correspond to the (super)cells 
    $1\times 1\times 1$, $2\times 1\times 1$, $2\times 1\times 2$ 
    and $3\times 1\times 2$, respectively.
%    $n$ is the number of MgO units in the (super)cell.
    Cell parameters and energies are in \AA~and atomic unit respectively.
  }\label{Tab:Forsterite}
  \begin{tabular}{crcccc}
  \toprule
%
% 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1
% b3lyp triple-zeta GOOD
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A          4.740117      0.001885      0.000000      4.740117
%          STRE_B         10.227458      0.001229      0.000000     10.227458
%          STRE_C          6.107109     -0.003163      0.000000      6.107109
%          ALPHA          90.000000     -0.000216      0.000000     90.000000
%          BETA           90.000000     -0.004659      0.000000     90.000000
%          GAMMA          90.000000     -0.004069      0.000000     90.000000
%          VOLM_L        296.068646     -0.000005      0.000000    296.068646
%     1    -3965.1673904250
%
% 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1
% b3lyp triple-zeta GOOD
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A          9.551844      0.003681      0.000000      9.551844
%          STRE_B         10.213044      0.000085      0.000000     10.213044
%          STRE_C          6.127509     -0.002413      0.000000      6.127509
%          ALPHA          90.000000      0.007276      0.000000     90.000000
%          BETA           90.000000     -0.000533      0.000000     90.000000
%          GAMMA          90.000000      0.004678      0.000000     90.000000
%          VOLM_L        597.759301     -0.000006      0.000000    597.759301
%     1    -7930.3051533414
% b3lyp triple-zeta TIGHT
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A          9.540204      0.000044      0.000000      9.540204
%          STRE_B         10.213910      0.000043      0.000000     10.213910
%          STRE_C          6.143471     -0.000055      0.000000      6.143471
%          ALPHA          90.000000      0.005176      0.000000     90.000000
%          BETA           90.000000      0.000025      0.000000     90.000000
%          GAMMA          90.000000      0.000325      0.000000     90.000000
%          VOLM_L        598.636902     -0.000001      0.000000    598.636902
%     1    -7930.3101284096
%
% 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2
% b3lyp triple-zeta GOOD
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A          9.581385     -0.001913      0.000000      9.581385
%          STRE_B         10.272478     -0.000525      0.000000     10.272478
%          STRE_C         12.050157      0.003022      0.000000     12.050157
%          ALPHA          90.000000      0.010020      0.000000     90.000000
%          BETA           90.000000      0.026387      0.000000     90.000000
%          GAMMA          90.000000      0.010248      0.000000     90.000000
%          VOLM_L       1186.031466     -0.000006      0.000000   1186.031466
%     1   -15860.7857090709
%
% 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2
% b3lyp triple-zeta GOOD
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A         14.385331     -0.000565      0.000000     14.385331
%          STRE_B         10.284986      0.000427      0.000000     10.284986
%          STRE_C         12.034432     -0.000027      0.000000     12.034432
%          ALPHA          90.000000      0.019238      0.000000     90.000000
%          BETA           90.000000      0.052125      0.000000     90.000000
%          GAMMA          90.000000      0.024294      0.000000     90.000000
%          VOLM_L       1780.529432     -0.000003      0.000000   1780.529432
%     1   -23791.1953304828
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1 1x1x1
% b3lyp double-zeta TIGHT
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A          4.726164     -0.000024      0.000000      4.726164
%          STRE_B         10.181053      0.000040      0.000000     10.181053
%          STRE_C          6.112551      0.000007      0.000000      6.112551
%          ALPHA          90.000000     -0.002500      0.000000     90.000000
%          BETA           90.000000      0.000738      0.000000     90.000000
%          GAMMA          90.000000     -0.000001      0.000000     90.000000
%          VOLM_L        294.119630      0.000000      0.000000    294.119630
% Clone #         Energy
%     1    -3965.0594336276
%
% 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1 2x1x1
% b3lyp double-zeta TIGHT
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A          9.523968     -0.000011      0.000000      9.523968
%          STRE_B         10.184572      0.000100      0.000000     10.184572
%          STRE_C          6.119075     -0.000053      0.000000      6.119075
%          ALPHA          90.000000      0.004220      0.000000     90.000000
%          BETA           90.000000     -0.000757      0.000000     90.000000
%          GAMMA          90.000000     -0.000980      0.000000     90.000000
%          VOLM_L        593.535171      0.000000      0.000000    593.535171
%     1    -7930.0861345846
%
% 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2 2x1x2
% b3lyp double-zeta TIGHT
%
%
% 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2 3x1x2
% b3lyp double-zeta TIGHT
%Lattice Parameter        Old Value      Gradient    Displacement   New Value
%          STRE_A         14.362687      0.000117      0.000000     14.362687
%          STRE_B         10.257567     -0.000034      0.000000     10.257567
%          STRE_C         11.990901     -0.000058      0.000000     11.990901
%          ALPHA          90.000000      0.001098      0.000000     90.000000
%          BETA           90.000000     -0.000375      0.000000     90.000000
%          GAMMA          90.000000     -0.000383      0.000000     90.000000
%          VOLM_L       1766.574086      0.000000      0.000000   1766.574086
%     1   -23790.5241758833
%
  & $n$ & $a_0$ & $b_0$ & $c_0$ & $E/n$ \\
  \hline
    {\sc MondoSCF}\footnote[1]{$\Gamma$-point.} 
% TZVP GOOD
%    &  4 & 4.74   & 10.23   & 6.11   & $-$991.2918 \\%
%    &  8 & 4.77   & 10.21   & 6.13   & $-$991.2881 \\%
%    & 16 & 4.79   & 10.27   & 6.02   & $-$991.2991 \\%
%    & 24 & 4.79   & 10.28   & 6.02   & $-$991.2998 \\%
% TZVP TIGHT
%    &  4 &    & 10.   & 6.   & $-$991. \\%
%    &  8 & 4.770 & 10.214 & 6.143 & $-$991.288766 \\%
%    & 16 &    & 10.   & 6.   & $-$991. \\%
%    & 24 &    & 10.   & 6.   & $-$991. \\%
% DZVP TIGHT
    &  4 & 4.726 & 10.181 & 6.119 & $-$991.264858 \\%
    &  8 & 4.762 & 10.184 & 6.119 & $-$991.260767 \\%
    & 16 &  &  &  & $-$ \\%
    & 24 & 4.787 & 10.257 & 5.995 & $-$991.271841 \\%
  \hline
    {\sc Vasp}\footnote[2]{$3\times 3\times 3$ $\mathbf{k}$-points~\cite{PJochym04}.}
    &  4 & 4.7995 & 10.3056 & 6.0408 & \\
  \hline
    {Exp.}\footnote[3]{Experimental values~\cite{HYoder57}.}
    &  4 & 4.756  & 10.195  & 5.981  & \\
  \botrule
  \end{tabular}
\end{table}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Comp: 
%a 4,7995 b 10,3056 c 6,0408 
% P. T. Jochym, K. Parlinski, P. Krzywiec, Computational Materials Science 29 (2004) 414­418
%Exp:                                    
%a 4,756  b 10,195  c 5,981
% H.S. Yoder, G. Sahama, The American Mineralogist 42 (1957) 475­491.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
As for the MgO case, the smallest system (Mg$_2$SiO$_4$)$_4$
shows a large discrepantcy for the cell parameters 
with respect to the {\sc Vasp} and experimental values. 
The larger systems  {\em i.e.} the $2\times 1\times 2$ and $3\times 1\times 2$ supercells
give cell parameters in very good agreement with the experimental data; 
and the energies systematical converge while the system grows.
%The total CPU time needed to fully relax the forsterite, 
%from the smallest to the biggest systems, were 592, 1664, 2816 and 8320 hours respectively.
The cell parameters obtained from the $\Gamma$-point
B3LYP/8-61G*(Mg)/88-31G*(Si)/8-51G*(O) level of theory 
deviate less than 1\% with respect to the experimental values.

\section{Conclusions}\label{Sec:Conclusions}
In a previous paper, construction of the analytical 
exact Hartree-Fock exchange gradients with respect to 
atomic and cell parameters within the $\Gamma$-point 
approximation has been introduced. 
In this article, the formalism for the evaluation of the density 
functional gradients at the $\Gamma$-point approximation for 
Cartesian Gaussian-type basis functions was presented and 
implemented in the {\sc MondoSCF} package.

As an illustration, the analytical gradients and cell gradients have been used
in conjunction with the QUICCA algorithm to optimize few 1D and 3D periodic systems at
the DFT and hybrid-HF/DFT levels.

Convergence of bond lengths, bond angles and 
cell parameters within the DFT and hybrid-HF/DFT $\Gamma$-point
super cell approach and under full relaxation with no symmetry
to the converged large cell $\Gamma$-point approximation have
been demonstrated for 1D and 3D systems to better than 3 digits.


Although the convergence of the Kohn-Sham density functional $\Gamma$-point total energy to
its ${\bf k}$-space integration counterpart with respect to cell size is relatively slow,
the convergence of the geometrical parameters (cell and atomic positions)
requires much smaller cells. Thus, we could show that a relative accuracy better
than 3 digits can be already achieved with cubic cells of about $600$\AA$^3$.\\



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Acknowledgements
\begin{acknowledgments}
% The authors would like to thank ... and ...
% for helpful comments.
 This work has been supported by the Swiss National Science Foundation, 
 the Swiss Office for Education and Science through the European 
 COST Action D14 and the US Department of Energy 
 under contract W-7405-ENG-36 and the ASCI project.  
 The Advanced Computing Laboratory of Los 
 Alamos National Laboratory is acknowledged.
\end{acknowledgments}  

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\bibliography{mondo_new}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix
\section{Computation of the derivative of the ${\cal M}$ 
  tensor with respect to cell parameters }\label{Apx:MDer}
%\begin{equation*}
%{\cal M}_{mlm'l'} = \sum_{{\bf R}\in PFF} M_{mlm'l'}({\bf R}).
%\end{equation*}
Following Tymczak and Challacombe~\cite{CTymczak04a}, the ${\cal M}$ tensor can be written into 
real and reciprocal space terms as
\begin{equation}\label{Eq:MTensor}
  \begin{split}
  {\cal M}^{m}_{l}&=\sum _{\mathbf{R}\in{\rm PFF}}\widetilde{P}_{l}^{m}
  \left(\cos\theta_{\mathbf{R}}\right)e^{im\phi_{\mathbf{R}}}{\cal G}_{l}\left(\beta,\left|\mathbf{R}\right|\right)\\
  &-\sum_{\mathbf{R}\in{\rm In}}\widetilde{P}_{l}^{m}\left(\cos\theta_{\mathbf{R}}\right) 
  e^{im\phi_{\mathbf{R}}}{\cal F}_{l}\left(\beta,\left|\mathbf{R}\right|\right)\\
  &+\frac{4\pi ^{\frac{3}{2}}(\frac{i}{2})^{l}}{V_{uc}\Gamma\left(l+\frac{1}{2}\right)}\\
  &\sum_{\mathbf{G}\neq\left\{\emptyset\right\}}G^{l-2}
  e^{-\frac{\pi^{2}G^{2}}{\beta^{2}}}\widetilde{P}_{l}^{m}\left(\cos\theta_{\mathbf{G}}\right) 
  e^{im\phi _{\mathbf{G}}},
  \end{split}
\end{equation}
where $\mathbf{G}$ is a reciprocal lattice vector, $G=|\mathbf{G}|$, $\widetilde{P}_{l}^{m}$ 
is the associated Legendre polynomial, $\beta=\sqrt{\pi }/V_{uc}^{\frac{1}{3}}$,
\begin{equation}
  {\cal G}_{l}\left( \beta ,r\right) =\frac{\gamma \left( l+\frac{1}{2},\beta ^{2}r^{2}\right) }
  {\Gamma \left( l+\frac{1}{2}\right)r^{l+1}}
\end{equation}
and
\begin{equation}
  {\cal F}_{l}\left( \beta ,r\right) =\frac{\Gamma \left( l+\frac{1}{2},\beta ^{2}r^{2}\right) }
  {\Gamma \left( l+\frac{1}{2}\right)r^{l+1}},
\end{equation}
where $\Gamma$ is the gamma function and $\gamma$ is the incomplete gamma function~\cite{MAbramowitz87}.
The derivative of ${\cal M}$ Eq.~\ref{Eq:MTensor} with respect to cell parameters $M_{ij}$ is
\begin{equation}\label{Eq:DerMTensor}
  \begin{split}
   \frac{\partial {\cal M}^{m}_{l} }{\partial M_{ij}}&=\sum _{\mathbf{R}\in {\rm PFF}}
   \frac{\partial\widetilde{P}_{l}^{m}}{\partial M_{ij}}
   e^{im\phi _{\mathbf{R}}}{\cal G}_{l}
   +im\widetilde{P}_{l}^{m}\frac{\partial\phi_{\mathbf{R}}}{\partial M_{ij}}e^{im\phi _{\mathbf{R}}}{\cal G}_{l}\\
   &+\widetilde{P}_{l}^{m}e^{im\phi _{\mathbf{R}}} \frac{\partial{\cal G}_{l}}{\partial M_{ij}}\\
   &-\sum_{\mathbf{R}\in {\rm In}}\frac{\partial\widetilde{P}_{l}^{m}}{\partial M_{ij}}e^{im\phi_{\mathbf{R}}}{\cal F}_{l}
   +im\widetilde{P}_{l}^{m}\frac{\partial\phi_{\mathbf{R}}}{\partial M_{ij}}e^{im\phi_{\mathbf{R}}}{\cal F}_{l}\\
   &+\widetilde{P}_{l}^{m} e^{im\phi_{\mathbf{R}}}\frac{\partial{\cal F}_{l}}{\partial M_{ij}}\\
   &-\frac{4\pi^{\frac{3}{2}}(\frac{i}{2})^{l}}{V_{uc}^2\Gamma\left(l+\frac{1}{2}\right)}
   \frac{\partial V_{uc}}{\partial M_{ij}}\\
   &\sum_{\mathbf{G}\neq\left\{\emptyset\right\}}G^{l-2}e^{-\frac{\pi^{2}\left|
       \mathbf{G}\right|^{2}}{\beta^{2}}}\widetilde{P}_{l}^{m}e^{im\phi _{\mathbf{G}}}\\
   &+\frac{4\pi^{\frac{3}{2}}(\frac{i}{2})^{l}}{V_{uc}\Gamma\left(l+\frac{1}{2}\right)}\\
   &\sum_{\mathbf{G}\neq\left\{\emptyset\right\}}
   (l-2)G^{l-3}\frac{\partial G}{\partial M_{ij}}
   e^{-\frac{\pi^{2}G^{2}}{\beta ^{2}}}
   \widetilde{P}_{l}^{m}e^{im\phi_{\mathbf{G}}}\\
   &-2\frac{\pi^2}{\beta^2}G^{l-1}
   \left(\frac{\partial G}{\partial M_{ij}}
   -\frac{G}{\beta}\frac{\partial\beta}{\partial M_{ij}}\right)
   e^{-\frac{\pi ^{2}G^{2}}{\beta^{2}}}
   \widetilde{P}_{l}^{m}e^{im\phi_{\mathbf{G}}}\\
   &+G^{l-2}
   e^{-\frac{\pi^{2}G^{2}}{\beta^{2}}}
   \frac{\partial\widetilde{P}_{l}^{m}}{\partial M_{ij}}e^{im\phi_{\mathbf{G}}}\\
   &+imG^{l-2}
   e^{-\frac{\pi ^{2}G^{2}}{\beta ^{2}}}
   \widetilde{P}_{l}^{m}\frac{\partial\phi_{\mathbf{G}}}{\partial M_{ij}}e^{im\phi_{\mathbf{G}}},
  \end{split}
\end{equation}
where 
\begin{equation*}
  \frac{\partial\widetilde{P}_{l}^{m}}{\partial M_{ij}}=
  \frac{\partial\widetilde{P}_{l}^{m}}{\partial\theta_{\mathbf{R}}}
  \frac{\partial\theta_{\mathbf{R}}}{\partial M_{ij}}
\end{equation*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}
%
% ****** End of file apssamp.tex ******
%
