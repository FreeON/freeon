\documentclass[prl,aps,twocolumn,showpacs,twocolumngrid,superbib]{revtex4}


\usepackage{graphicx}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{alltt}
\usepackage{fancyhdr}
\newcommand{\bms}[1]{{\boldsymbol #1}}

%\draft
%\tighten
\pagestyle{fancy}


%\eprint{LA-UR-04-1097}

\begin{document}

\title{
A New View on the Geometry Optimization of Large Molecules            
}

\author{K\'aroly N\'emeth}\email{nemeth@lanl.gov}
\author{Matt Challacombe}

\affiliation{Theoretical Division, Los Alamos National Laboratory, Los Alamos, NM 87545, USA}

\date{\today}

\begin{abstract}
{
This communication peresents a new, efficient alternative to well established
geometry optimization algorithms. The new alternative is based on
fitting gradient surfaces in terms of curvilinear 
internal coordinates and 
determining the roots of the fitted surface. Due to the efficient 
vibrational decoupling of the curvilinear coordinates the 3N-dimesional
optimization problem splits into a quasi non-interacting
set of approximately 3N one-dimensional optimization problems, 
similarly to the self-consistent mean-field concepts of physics.
This allows for robust, linear scaling implementation of geometry optimizers.
}

\smallskip
\noindent{\bf Keywords}: 
geometry optimization, linear scaling, 
curvilinear internal coordinates, fitting
\end{abstract}
 
\pacs{?????????????????02.70.-c, 71.15.-m, 71.15.Dx}

\maketitle

\footnotetext[1]{LA-UR-04-1097}

The optimization of molecular structures is one of the most frequent
tasks carried out by computational chemists. 
Structures of large molecules have been optimized so far
only with the use of empirical force-fields, or at most with 
semi-empirical electronic structure theories 
\cite{Stewart_crambin_opt,Schlegel_plasminogen_opt}. However, many important phenomena
can be understood only poorly on these low levels of the theory. 
Such phenomena are e.g. the structural changes of large molecules, 
when beeing put from one solvent into another, the mechanisms of 
enzymatic reactions, the selectivities of ion-channels, etc. 
Geometry optimization is one of the simplest tools to start studying 
these phenomena, since it needs only energy gradients, as input, but 
leads to a welth of relevant structural information.
Not only equilibrium structures, but also transition states and reaction
paths can be determined with the help of efficient optimizers 
\cite{nudged_elastic_band}.

With the advent of linear scaling electronic structure techniques 
\cite{Goedecker99}
energies and gradients are available for large molecules on demanding
levels of the theory. 
The task of an efficient optimizer is, to reduce the number of
expensive energy and gradient evaluations.

In the last three decades the so-called internal coordinate 
geometry optimizers 
became standard tools of structural optimization when energies 
and forces are calculated by electronic structure theory 
\cite{Pulay_natural_internals}.
Internal coordinates describe the internal motions of molecules 
by displacements of chemical entities, such as bond-stretches, 
valence angle bendings and torsions of dihedral angles. These 
coordinates are curvilinear, since they can be composed
as non-linear functions of the Cartesian coordinates of atomic nuclei.

An important property of these chemical
internal coordinates
is that they significantly reduce the harmonic and higher order 
vibrational coupling, as compared to Cartesian coordinates. 
In internal coordinate representation it is much easier to estimate 
harmonic and higher order force-constants than in Cartesian. Even
if accurate harmonic force-constants are available, internal coordinates
are superior for geometry optimization, since anharmonic effects are
usually large. In practice, accurate harmonic force constants are 
not available for geometry optimization, since their calculation 
is very expensive.

Internal coordinates represent a natural energy and 
length-scale separation of molecular movements.
The stiffest molecular motions are usually those of strechings, while 
the softest ones are related to torsions. 
Typical harmonic force constants for stretches are in the order of 
0.5 atomic units (a.u.), those of bendings are of 0.2 a.u. and the
torsions are around 0.1 a.u or below. 
These typical values however, can vary a lot.
For example, a double bond is much stiffer than a single bond or 
a hydrogen-bridge. Also, the values of the force constants depend
on the actual conformation of the molecule. Thus, a rough estimate
of these force constants is usually not satisfactory 
for an efficient optimization
of complex molecules. However it is often enough in the case of small
molecules \cite{fogarasi_diaghess}.

In order to get more accurate curvature information about the 
potential energy surface the so-called Hessian-matrix update schemes
are used \cite{RFletcher}. 
Hessian matrix update schemes are derived from the assumption of a 
harmonic potential energy surface. A series of rank-1 updates
can build the exact Hessian matrix using gradients and displacements
of consequtive geometry optimization steps.
E.g. for a 100 atom system, on an ideal harmonic surface 300 rank-1
updates are necessary to to build the exact Hessian. The success
of Hessian update schemes is based on, that for geometry optimization
an imperfect Hessian is enough to bring the molecule to a local 
optimum by quasi-Newton steps. 
It should also be obvious, that the assumption of a harmonic potential energy 
surface is a very crude approach to the molecular reality. 
It holds best for the motions of covalent bonds, and least for
hydrogen bonds or interchain interactions. Since large molecules of practical
interest are usually full of hydrogen bonds, it is needless to say how
crude the harmonic approximation is.
In order to maintain convergence to a local
minimum instead of a transition state, the positive definite nature
of the updated Hessian must always be ensured. However, as 
an approximate Hessian cannot provide absolute certainty about the 
nature of a local extremum, the exact Hessian remains the only tool
to examine the quality of the extremum with full reliability. 
This problem has been investigated
in Ref \cite{Wales_saddlepoint} for the case of 
gradients-only optimizations.

The updated Hessian matrices require ${\cal{O}}(N^{2})$ storage, thus
their use becomes a computational bottleneck for large molecules.
There are a few approaches to overcome this limitation.
The most widely used one is the Limited Memory BFGS (LBFGS) 
technique of Nocedal
{\it et.al.} \cite{nocedal_lbgs}. This technique does never explicitely 
construct the full Hessian matrix. Instead, it carries out all 
the necessary operations by an implicite application of the Hessian
via its component vectors. LBFGS
has the limitation that it can use only a small number of remembered
steps.
LBFGS has never been used in conjuction with internal coordinates
for large systems yet.
Another efficient approach has been constructed very recently by Bofill,
Anglada et.al. \cite{bofill_lanczos}. This approach is similar
to LBFGS in the sense that it avoids the use of the explicite
Hessian, but it can calculate necessary eigenvectors of the 
Hessian by a Lanczos-type algorithm. A
similar approach is the ${\cal{O}}(N^{2})$ scaling iterative
scheme of Schlegel and Farkas \cite{schlegel_on2iter}.
In Stewart's approach, an update
formula of the inverse Hessian has been used, and the full explicite
Hessian has been truncated by spacial thresholding and stored in a 
sparse matrix fashion \cite{Stewart_crambin_opt}. 
The reported performance
of Stuart's scheme was rather poor on large molecules.

The efficient use of internal coordinates for large molecules has 
been limited by another important factor. That is the coordinate
transformation problem, which must be carried out very frequently
to transform Cartesian vectors and curvilinear internal ones into each
other. This problem has found a linear scaling solution   
only in recent developments 
\cite{paizs_coordtrf1,nemeth_coordtrf1,paizs_coordtrf2,nemeth_coordtrf2,billeter_coordtrf,andzelm_coordtrf,kudin_coordtrf}. 

In the present communication we introduce a fundamentally new approach
to molecular geometry optimization. We call this approach the
Gradient Curve Fitting (GCF) technique. This new approach is very simple
to implement, scales fully linearly with system size 
and is very efficient for both small and large molecules.

The new algorithm is based on the simple observation that
normal mode gradients are linear functions of the normal mode values 
on harmonic potential energy surfaces. 
In the process of geometry optimization the goal is to reveal the roots
of these lines, where all gradients become zero. In order to 
find these roots, first a few points should be determined from each
lines, then the roots can be revealed by line-fitting. 

In a realistic case neither the potential energy surface is 
harmonic, nor the normal modes are available. However, it is always
possible to construct internal coordinates based on the chemical
intuition, and these internal coordinates will have a reduced
vibrational coupling, similar to normal modes. The corresponding
gradient curves will not be straight lines for internal coordinates,
but they still represent stronger or weaker tendencies, as the molecular
structure walks on the potential energy surface, e.g. during geometry
optimization.
See Fig. \ref{NH3outp6} for a typical progression of internal
coordinate gradients during geometry optimization.
These tendencies can again be revealed by fitting curves to the
coordinate-gradient data pairs. For each internal coordinate 
the root of the fitted curve then 
serves as a new estimate for the coordinate value where the gradient
should become zero. Repeating this fitting process can finally
reveal a local optimum of the the potential energy surface.
The fitting of gradient surfaces has already been applied to 
the parametrization of empirical
force-fields for the case of small molecules
\cite{force-field-fitting}, however it 
has not been investigated for the purpose of geometry optimization yet.
\begin{figure}[h]
%\resizebox*{3.5in}{!}{\includegraphics{1_6_6_Data.eps}}
%\resizebox*{3.5in}{!}{\includegraphics{1_5_6_Data.eps}}
\resizebox*{3.5in}{!}{\includegraphics{1_7_6_Data.eps}}
\caption{
\small  
Progression of gradients on a valence angle bending coordinate of
ammonia. The optimization was started from near planar geometry, i.e.
from the vicinity of a transition state, and converged to a local 
minimum of the potential energy surface. The numbers in the picture
indicate the sequence of optimization steps.
\label{NH3outp6}
}
\end{figure}
The fitting of curves happens through 
well established and robust algorithms, which are available in standard 
computational libraries 
\cite{slatec}. 
It is important to note
that data points are weighted before the fit. The weights, 
$w_{k}^{(i)}$, are
measures of the stuctural tension in the vicinity of the $k$-th internal
coordinate at the $i$-th geometry. They account for the effect of the 
environment on the $k$-th internal coordinate. 
The weights are computed as
\begin{equation}
w_{k}^{(i)} = \left[ \sum_{l} g_{l}^{(i)} \frac{1}{|H_{ll}^{}|} g_{l}^{(i)} \right]^{-1} ,
\end{equation}
where $l$ indicates the internal coordinates which have atoms in common
with the $k$-th internal coordinate, i.e. which are in the spacial 
vicinity of the $k$-th coordinate. $H_{ll}^{}$ is an estimate
of the diagonal matrix element of the Hessian for the $l$-th 
internal coordinate. $H_{ll}^{i}$ is calculated as the local tangent
of the gradient curve of a primary fit. 
%\begin{equation}
%H_{ll}^{i} = \left . \frac{\partial g_{l}^{(i)}}{\partial r_{l}^{}} \right|_{r_{l}^{}=r_{l}^{(i)}}
%\end{equation}
The primary fit is done with 
the weights $w{'}_{k}^{(i)} = 1/g_{k}^{(i)2}$ usual to 
estimate relative errors.
The statistical F test is used to decide about the order of the fit. 
So far no higher than quadratic fit has been considered.

If the gradient curve has a negative tangent at the position
of the root, it is an indication for a transition state. 
Eg. in Fig. \ref{NH3outp6}
the tangent of the gradient curve is negative 
in the vicinity of the planar
structure (structure \#1). This should be so, since the planar
ammonia represents a transition state. The tangent of the gradient 
curve thus offers a
convenient tool to control convergence to minima or transition state.
We plan to elaborate a transition state finding tool based on this 
principle. In the present communication we restrict the discussion
to the localization of minima. Whenever the local tangent  
of the gradient curve
is negative, the optimizer moves the actual geometry away from 
the transition state. This way those transition states 
can be avoided, which are localized well on a few internal coordinates. 
In the present paper we do not consider the case of more 
delocalized transition states which are in principle possible,
however rarely occure. Combined internal coordinates, such
as the natural internal ones \cite{Pulay_natural_internals} or the
delocalized internal ones \cite{Baker_deloc_1} hold the possibility
of revealing more delocalized transition states by the
curve fitting technique.
%Internal coordinates are redefined at each step of the optimization.
%This is important for large molecules, since conformational
%changes may lead to the appearence of new bonds, eg. hydrogen bridges,
%while some other bonds may disappear.
%for the large paper, note, that merging of topologies is 
%necessary at this point for the sake of stable coordinate 
%transformations.
%
%It is typical in one-dimensional root-finding to bracket the root of
%the function. After the root is bracketed, usual techniques, like
%the golden section can be applied. In the case of geometry optimization
%the root of a varying function has to be found, since the form of
%the gradient curve converges only at the end the optimization.
%For this, it is advantageous to bracket the root at each step, 
%instead of
%going directly for it. For the purpose of bracketing $\sigma$, 
%the standard uncertainty of the predicted root is determined. 
%Then, an extra amount of displacement, proportional to $\sigma$
%is used to overshoot the predicted root.
%
We will provide detailed information about the technology of 
the Gradient Curve Fitting
optimizer in a forthcoming paper \cite{bisect-paper}.

The performance of this initial implementation of the GCF optimizer
has been tested on a 
series of small molecules, called Baker's test set \cite{bakerstest}.
Table \ref{Bakers_test} lists all the test results
in order to convince
the reader, that our fundamentally new approach to geometry optimization
works as well on small molecules as the best traditional techniques.
\begin{table}[h]
\squeezetable
\caption{
Geometry optimization steps of small molecules (upto 30 atoms)
of the Baker's test set. Calculations have been carried out 
with the Hartree-Fock model in STO-3G basis set.
At convergence, Cartesian force vectors were shorter 
than $3\times10^{-4}$ atomic units, on all atoms. Energies have been
reproduced to all digits of the published values 
of Ref. \cite{bakerstest}.
Note, that all calculations of this table used standard primitive 
internal coordinates, except the one by Bakken \cite{bakken}, 
which was based on the so called extra redundant coordinates.
}
\label{Bakers_test}
\begin{tabular}{lccccc}
\toprule
Molecule               & Present  & Bakken & Eckert  & Lindh &  Baker  \\
         & work & {\it{et al.}} & {\it{et al.}} & {\it{et al.}} &    \\
         &(GCF) &  \cite{bakken} &  \cite{eckert} & \cite{lindh} &  \cite{bakerstest} \\
\colrule
Water                  &   4    &   4    &    4    &    4   &   6     \\
Ammonia                &   4    &   5    &    6    &    5   &   6     \\
Ethane                 &   4    &   3    &    4    &    4   &   5     \\
Acetylene              &   4    &   4    &    6    &    5   &   6     \\
Allene                 &   3    &   4    &    4    &    5   &   5     \\
Hydroxysulphane        &   7    &   7    &    7    &    8   &   8     \\
Benzene                &   2    &   3    &    3    &    3   &   4     \\
Methylamin             &   4    &   4    &    5    &    5   &   6     \\
Ethanol                &   5    &   4    &    5    &    5   &   6     \\
Acetone                &   5    &   4    &    5    &    5   &   6     \\
Disilyl ether          &   9    &   8    &    9    &   11   &   8     \\
1,3,5-trisilacycl.     &   6    &   9    &    6    &    8   &   8     \\
Benzaldehyde           &   4    &   4    &    5    &    5   &   6     \\
1,3-difluorobenz.      &   4    &   4    &    5    &    5   &   5     \\
1,3,5-trifluorob.      &   3    &   4    &    4    &    4   &   5     \\
Neopentane             &   5    &   4    &    4    &    5   &   5     \\
Furan                  &   6    &   5    &    6    &    7   &   8     \\
Naphtalene             &   6    &   5    &    6    &    6   &   5     \\
1,5-difluoronapht.     &   6    &   5    &    6    &    6   &   6     \\
2-hydroxibicyclop.     &   8    &   9    &    9    &   10   &  15     \\
ACHTAR10               &   9    &   8    &    9    &    8   &  12     \\
ACANIL01               &  11    &   7    &    8    &    8   &   8     \\
Benzidine              &   8    &   9    &    7    &   10   &   9     \\
Pterin                 &  14    &   8    &    9    &    9   &  10     \\
Difuropirazine         &   7    &   6    &    7    &    7   &   9     \\
Mesityl oxide          &   5    &   5    &    6    &    6   &   7     \\
Histidine              &  10    &  16    &   14    &   20   &  19     \\
Dimethylpenthane       &   7    &   9    &   10    &   10   &  12     \\
Caffeine               &   7    &   6    &    7    &    7   &  12     \\
Menthone               &  16    &  12    &   10    &   14   &  13     \\
\colrule
Total                  & 193    & 185    &  196    &  215   & 240     \\
\botrule
\end{tabular}
\end{table}
While retaining the same efficiency for small molecules, our technique
is fully linear scaling as opposed to any other internal 
coordinate optimizers reported so far. In addition, it is far simpler
to implement then any traditional alternatives.
This allowes the fast and efficient 
extension of geometry optimization 
to large molecules, where scaling issues are important.
In order to illustrate the performance of our optimizer on large
molecules, we show the convergence of the molecular total energy
during the course of the optimization of a 257 atom
fragment of Protein Kinase A, in Figs. \ref{logn-logde} 
and \ref{order-of-conv}. 10 periferial atoms have been 
constrained, in order to mimic the rest of the enzyme, 
all other atoms have been allowed to move.
The optimizations have been carried out 
using MondoSCF \cite{MondoSCF}, a linear scaling electronic structure
program system, the PBE density functional model and 
STO-2G basis set, with 0.1 milliHartree resolution of the energies.
The convergence was smooth with minor jumps in the energy.
A first order convergence is typical for the bulk of the optimization
of larger molecules. For smaller molecules, like the ones of Baker's
test set, the order of convergence is between linear and quadratic,
with an acceleration towards convergence. Note, that in the case
of first order convergence the rate of the convergence is still
smaller than one, which results in decreasing error.
\begin{figure}[h]
\resizebox*{3.5in}{!}{\includegraphics{curve3.eps}}
\caption{
\small  
The error of the energy has an exponential decline during
the optimization of a 257 atom protein kinase A fragment. 
$i$ denotes the serial number of steps,
$E_{opt}$ is the optimum energy.
\label{logn-logde}
}
\end{figure}
%
%
%
%
\begin{figure}[h]
\resizebox*{3.5in}{!}{\includegraphics{curve2.eps}}
\caption{
\small  
Relative errors of the energy show linear improvement.
Thus, the convergence is of first order. Higher order
convergence can be expected only beyond the milliHartree
energy resolution for this molecular size.
\label{order-of-conv}
}
\end{figure}
In this communication we have presented a fundamentally new approach
to the optimization of molecular structures.
We have shown, that internal coordinates representing chemical 
entities can efficiently be optimized, without
ever accounting for explicite vibrational couplings, as traditional
optimization techniques do. This allowes an efficient
extension of quantum-level modeling to geometrical processes
of biomolecules, such as enzymatic reactions, macroscopic quantum 
effects in ion-channels or solvent effects on biomolecules.
Our technique can also be used
to provide simple and accurate updates of force-fields
for molecular dynamics simulations, based on the availability of
quantum-mechanical forces.
%
%
\bibliography{mondo_new}
\end{document}
