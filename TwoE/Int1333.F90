! ---------------------------------------------------------- 
! COMPUTES THE INTEGRAL CLASS (S P|P P) 
! ---------------------------------------------------------- 
   SUBROUTINE Int1333(PrmBufB,LBra,PrmBufK,LKet,ACInfo,BDInfo, & 
                              OA,LDA,OB,LDB,OC,LDC,OD,LDD,PBC,I) 
      USE DerivedTypes
      USE VScratch
      USE GlobalScalars
      USE ShellPairStruct
      USE GammaF3
      IMPLICIT REAL(DOUBLE) (A,I,W)
      INTEGER        :: LBra,LKet
      REAL(DOUBLE)   :: PrmBufB(7,LBra),PrmBufK(7,LKet)
      TYPE(SmallAtomInfo) :: ACInfo,BDInfo
      TYPE(PBCInfo) :: PBC
      REAL(DOUBLE) :: I(*)
      REAL(DOUBLE)  :: Zeta,Eta,r1xZpE,HfxZpE,r1x2E,r1x2Z,ExZpE,ZxZpE,Omega,Up,Uq,Upq
      REAL(DOUBLE)  :: Ax,Ay,Az,Bx,By,Bz,Cx,Cy,Cz,Dx,Dy,Dz,Qx,Qy,Qz,Px,Py,Pz
      REAL(DOUBLE)  :: QCx,QCy,QCz,PAx,PAy,PAz,PQx,PQy,PQz,WPx,WPy,WPz,WQx,WQy,WQz   
      REAL(DOUBLE)  :: T,ET,TwoT,InvT,SqInvT,ABx,ABy,ABz,CDx,CDy,CDz
      INTEGER       :: OffSet,OA,LDA,OB,LDB,OC,LDC,OD,LDD,J,K,L
      REAL(DOUBLE)  :: FPQx,FPQy,FPQz
      I1Bar1=0.0d0
      I2Bar1=0.0d0
      I3Bar1=0.0d0
      I4Bar1=0.0d0
      I1Bar2=0.0d0
      I2Bar2=0.0d0
      I3Bar2=0.0d0
      I4Bar2=0.0d0
      I1Bar3=0.0d0
      I2Bar3=0.0d0
      I3Bar3=0.0d0
      I4Bar3=0.0d0
      I1Bar4=0.0d0
      I2Bar4=0.0d0
      I3Bar4=0.0d0
      I4Bar4=0.0d0
      I1Bar5=0.0d0
      I2Bar5=0.0d0
      I3Bar5=0.0d0
      I4Bar5=0.0d0
      I1Bar6=0.0d0
      I2Bar6=0.0d0
      I3Bar6=0.0d0
      I4Bar6=0.0d0
      I1Bar7=0.0d0
      I2Bar7=0.0d0
      I3Bar7=0.0d0
      I4Bar7=0.0d0
      I1Bar8=0.0d0
      I2Bar8=0.0d0
      I3Bar8=0.0d0
      I4Bar8=0.0d0
      I1Bar9=0.0d0
      I2Bar9=0.0d0
      I3Bar9=0.0d0
      I4Bar9=0.0d0
      I1Bar10=0.0d0
      I2Bar10=0.0d0
      I3Bar10=0.0d0
      I4Bar10=0.0d0
      Ax=ACInfo%Atm1X
      Ay=ACInfo%Atm1Y
      Az=ACInfo%Atm1Z
      Bx=ACInfo%Atm2X
      By=ACInfo%Atm2Y
      Bz=ACInfo%Atm2Z
      Cx=BDInfo%Atm1X
      Cy=BDInfo%Atm1Y
      Cz=BDInfo%Atm1Z
      Dx=BDInfo%Atm2X
      Dy=BDInfo%Atm2Y
      Dz=BDInfo%Atm2Z
      ABx=Ax-Bx
      ABy=Ay-By
      ABz=Az-Bz
      CDx=Cx-Dx
      CDy=Cy-Dy
      CDz=Cz-Dz
      DO J=1,LKet ! K^2 VRR |N0) loop 
         Eta=PrmBufK(1,J)
         Qx =PrmBufK(2,J)
         Qy =PrmBufK(3,J)
         Qz =PrmBufK(4,J)
         Uq =PrmBufK(5,J)
         QCx=Qx-Cx
         QCy=Qy-Cy
         QCz=Qz-Cz
         DO K=1,LBra ! K^2 VRR (M0| loop 
            Zeta=PrmBufB(1,K)
            Px  =PrmBufB(2,K)
            Py  =PrmBufB(3,K)
            Pz  =PrmBufB(4,K)
            Up  =PrmBufB(5,K)
            r1xZpE=One/(Zeta+Eta)
            Upq=SQRT(r1xZpE)*Up*Uq
            HfxZpE=Half/(Zeta+Eta)
            r1x2E=Half/Eta
            r1x2Z=Half/Zeta
            ExZpE=Eta*r1xZpE
            ZxZpE=Zeta*r1xZpE
            Omega=Eta*Zeta*r1xZpE
            PAx=Px-Ax
            PAy=Py-Ay
            PAz=Pz-Az
            PQx=Px-Qx
            PQy=Py-Qy
            PQz=Pz-Qz
      ! Need to be improve...
            FPQx = PQx*PBC%InvBoxSh%D(1,1)+PQy*PBC%InvBoxSh%D(1,2)+PQz*PBC%InvBoxSh%D(1,3)
            FPQy = PQy*PBC%InvBoxSh%D(2,2)+PQz*PBC%InvBoxSh%D(2,3)
            FPQz = PQz*PBC%InvBoxSh%D(3,3)
            IF(PBC%AutoW%I(1)==1) FPQx = FPQx-ANINT(ANINT(FPQx*1d9)*1d-9)
            IF(PBC%AutoW%I(2)==1) FPQy = FPQy-ANINT(ANINT(FPQy*1d9)*1d-9)
            IF(PBC%AutoW%I(3)==1) FPQz = FPQz-ANINT(ANINT(FPQz*1d9)*1d-9)
            PQx  = FPQx*PBC%BoxShape%D(1,1)+FPQy*PBC%BoxShape%D(1,2)+FPQz*PBC%BoxShape%D(1,3)
            PQy  = FPQy*PBC%BoxShape%D(2,2)+FPQz*PBC%BoxShape%D(2,3)
            PQz  = FPQz*PBC%BoxShape%D(3,3)
      !
            WPx = -Eta*PQx*r1xZpE
            WPy = -Eta*PQy*r1xZpE
            WPz = -Eta*PQz*r1xZpE
            WQx = Zeta*PQx*r1xZpE
            WQy = Zeta*PQy*r1xZpE
            WQz = Zeta*PQz*r1xZpE
            T=Omega*(PQx*PQx+PQy*PQy+PQz*PQz)
            IF(T<Gamma_Switch)THEN
              L=AINT(T*Gamma_Grid)
              ET=EXP(-T)
              TwoT=Two*T
              W3=(F3_0(L)+T*(F3_1(L)+T*(F3_2(L)+T*(F3_3(L)+T*F3_4(L)))))
              W2=+2.000000000000000D-01*(TwoT*W3+ET)
              W1=+3.333333333333333D-01*(TwoT*W2+ET)
              W0=TwoT*W1+ET
              AuxR0=Upq*W0
              AuxR1=Upq*W1
              AuxR2=Upq*W2
              AuxR3=Upq*W3
            ELSE
              InvT=One/T
              SqInvT=DSQRT(InvT)
              AuxR0=+8.862269254527580D-01*Upq*SqInvT
              SqInvT=SqInvT*InvT
              AuxR1=+4.431134627263790D-01*Upq*SqInvT
              SqInvT=SqInvT*InvT
              AuxR2=+6.646701940895685D-01*Upq*SqInvT
              SqInvT=SqInvT*InvT
              AuxR3=+1.661675485223921D+00*Upq*SqInvT
            ENDIF
      V(1)=AuxR0*PAx
      V(2)=AuxR1*WPx
      V(3)=AuxR0*PAy
      V(4)=AuxR1*WPy
      V(5)=AuxR0*PAz
      V(6)=AuxR1*WPz
      V(7)=AuxR0*QCx
      V(8)=AuxR1*WQx
      V(9)=AuxR1*HfxZpE
      V(10)=V(1)+V(2)
      V(11)=QCx*V(10)
      V(12)=AuxR1*PAx
      V(13)=AuxR2*WPx
      V(14)=V(12)+V(13)
      V(15)=WQx*V(14)
      V(16)=V(3)+V(4)
      V(17)=QCx*V(16)
      V(18)=AuxR1*PAy
      V(19)=AuxR2*WPy
      V(20)=V(18)+V(19)
      V(21)=WQx*V(20)
      V(22)=V(5)+V(6)
      V(23)=QCx*V(22)
      V(24)=AuxR1*PAz
      V(25)=AuxR2*WPz
      V(26)=V(24)+V(25)
      V(27)=WQx*V(26)
      V(28)=AuxR0*QCy
      V(29)=AuxR1*WQy
      V(30)=QCy*V(10)
      V(31)=WQy*V(14)
      V(32)=QCy*V(16)
      V(33)=WQy*V(20)
      V(34)=QCy*V(22)
      V(35)=WQy*V(26)
      V(36)=AuxR0*QCz
      V(37)=AuxR1*WQz
      V(38)=QCz*V(10)
      V(39)=WQz*V(14)
      V(40)=QCz*V(16)
      V(41)=WQz*V(20)
      V(42)=QCz*V(22)
      V(43)=WQz*V(26)
      V(44)=AuxR1*QCx
      V(45)=AuxR2*WQx
      V(46)=V(44)+V(45)
      V(47)=AuxR1*ZxZpE
      V(48)=-V(47)
      V(49)=AuxR0+V(48)
      V(50)=r1x2E*V(49)
      V(51)=AuxR2*HfxZpE
      V(52)=AuxR2*PAx
      V(53)=AuxR3*WPx
      V(54)=V(52)+V(53)
      V(55)=ZxZpE*V(14)
      V(56)=-V(55)
      V(57)=V(1)+V(2)+V(56)
      V(58)=r1x2E*V(57)
      V(59)=AuxR2*PAy
      V(60)=AuxR3*WPy
      V(61)=V(59)+V(60)
      V(62)=ZxZpE*V(20)
      V(63)=-V(62)
      V(64)=V(3)+V(4)+V(63)
      V(65)=r1x2E*V(64)
      V(66)=AuxR2*PAz
      V(67)=AuxR3*WPz
      V(68)=V(66)+V(67)
      V(69)=ZxZpE*V(26)
      V(70)=-V(69)
      V(71)=V(5)+V(6)+V(70)
      V(72)=r1x2E*V(71)
      V(73)=V(28)+V(29)
      V(74)=AuxR1*QCy
      V(75)=AuxR2*WQy
      V(76)=V(74)+V(75)
      V(77)=HfxZpE*V(76)
      V(78)=V(30)+V(31)
      V(79)=QCy*V(14)
      V(80)=WQy*V(54)
      V(81)=V(79)+V(80)
      V(82)=V(9)+V(32)+V(33)
      V(83)=QCy*V(20)
      V(84)=WQy*V(61)
      V(85)=V(51)+V(83)+V(84)
      V(86)=V(34)+V(35)
      V(87)=QCy*V(26)
      V(88)=WQy*V(68)
      V(89)=V(87)+V(88)
      V(90)=V(36)+V(37)
      V(91)=AuxR1*QCz
      V(92)=AuxR2*WQz
      V(93)=V(91)+V(92)
      V(94)=HfxZpE*V(93)
      V(95)=V(38)+V(39)
      V(96)=QCz*V(14)
      V(97)=WQz*V(54)
      V(98)=V(96)+V(97)
      V(99)=V(40)+V(41)
      V(100)=QCz*V(20)
      V(101)=WQz*V(61)
      V(102)=V(100)+V(101)
      V(103)=V(9)+V(42)+V(43)
      V(104)=QCz*V(26)
      V(105)=WQz*V(68)
      V(106)=V(51)+V(104)+V(105)
      I1Bar1=AuxR0+I1Bar1
      I2Bar1=I2Bar1+V(1)+V(2)
      I3Bar1=I3Bar1+V(3)+V(4)
      I4Bar1=I4Bar1+V(5)+V(6)
      I1Bar2=I1Bar2+V(7)+V(8)
      I2Bar2=I2Bar2+V(9)+V(11)+V(15)
      I3Bar2=I3Bar2+V(17)+V(21)
      I4Bar2=I4Bar2+V(23)+V(27)
      I1Bar3=I1Bar3+V(28)+V(29)
      I2Bar3=I2Bar3+V(30)+V(31)
      I3Bar3=I3Bar3+V(9)+V(32)+V(33)
      I4Bar3=I4Bar3+V(34)+V(35)
      I1Bar4=I1Bar4+V(36)+V(37)
      I2Bar4=I2Bar4+V(38)+V(39)
      I3Bar4=I3Bar4+V(40)+V(41)
      I4Bar4=I4Bar4+V(9)+V(42)+V(43)
      W1=I1Bar5+QCx*(V(7)+V(8))
      W2=WQx*V(46)+V(50)
      I1Bar5=W1+W2
      W1=I2Bar5+QCx*(V(9)+V(11)+V(15))
      W2=HfxZpE*V(46)
      W3=WQx*(QCx*V(14)+V(51)+WQx*V(54))
      W4=V(58)
      I2Bar5=W1+W2+W3+W4
      W1=I3Bar5+QCx*(V(17)+V(21))
      W2=WQx*(QCx*V(20)+WQx*V(61))+V(65)
      I3Bar5=W1+W2
      W1=I4Bar5+QCx*(V(23)+V(27))
      W2=WQx*(QCx*V(26)+WQx*V(68))+V(72)
      I4Bar5=W1+W2
      I1Bar6=I1Bar6+QCx*V(73)+WQx*V(76)
      I2Bar6=I2Bar6+V(77)+QCx*V(78)+WQx*V(81)
      I3Bar6=I3Bar6+QCx*V(82)+WQx*V(85)
      I4Bar6=I4Bar6+QCx*V(86)+WQx*V(89)
      I1Bar7=I1Bar7+V(50)+QCy*V(73)+WQy*V(76)
      I2Bar7=I2Bar7+V(58)+QCy*V(78)+WQy*V(81)
      I3Bar7=I3Bar7+V(65)+V(77)+QCy*V(82)+WQy*V(85)
      I4Bar7=I4Bar7+V(72)+QCy*V(86)+WQy*V(89)
      I1Bar8=I1Bar8+QCx*V(90)+WQx*V(93)
      I2Bar8=I2Bar8+V(94)+QCx*V(95)+WQx*V(98)
      I3Bar8=I3Bar8+QCx*V(99)+WQx*V(102)
      I4Bar8=I4Bar8+QCx*V(103)+WQx*V(106)
      I1Bar9=I1Bar9+QCy*V(90)+WQy*V(93)
      I2Bar9=I2Bar9+QCy*V(95)+WQy*V(98)
      I3Bar9=I3Bar9+V(94)+QCy*V(99)+WQy*V(102)
      I4Bar9=I4Bar9+QCy*V(103)+WQy*V(106)
      I1Bar10=I1Bar10+V(50)+QCz*V(90)+WQz*V(93)
      I2Bar10=I2Bar10+V(58)+QCz*V(95)+WQz*V(98)
      I3Bar10=I3Bar10+V(65)+QCz*V(99)+WQz*V(102)
      I4Bar10=I4Bar10+V(72)+V(94)+QCz*V(103)+WQz*V(106)
         ENDDO ! (M0| loop
      ENDDO ! |N0) loop
      ! HRR 
      V(1)=CDx*I1Bar2
      V(2)=I1Bar5+V(1)
      V(3)=CDx*I1Bar3
      V(4)=I1Bar6+V(3)
      V(5)=CDx*I1Bar4
      V(6)=I1Bar8+V(5)
      V(7)=CDy*I1Bar2
      V(8)=I1Bar6+V(7)
      V(9)=CDy*I1Bar3
      V(10)=I1Bar7+V(9)
      V(11)=CDy*I1Bar4
      V(12)=I1Bar9+V(11)
      V(13)=CDz*I1Bar2
      V(14)=I1Bar8+V(13)
      V(15)=CDz*I1Bar3
      V(16)=I1Bar9+V(15)
      V(17)=CDz*I1Bar4
      V(18)=I1Bar10+V(17)
      OffSet=(OA+0)*LDA+(OB+0)*LDB+(OC+0)*LDC+(OD+0)*LDD 
      I(OffSet)=CDx*I2Bar2+I2Bar5+I(OffSet)+ABx*V(2)
      OffSet=(OA+0)*LDA+(OB+1)*LDB+(OC+0)*LDC+(OD+0)*LDD 
      I(OffSet)=CDx*I3Bar2+I3Bar5+I(OffSet)+ABy*V(2)
      OffSet=(OA+0)*LDA+(OB+2)*LDB+(OC+0)*LDC+(OD+0)*LDD 
      I(OffSet)=CDx*I4Bar2+I4Bar5+I(OffSet)+ABz*V(2)
      OffSet=(OA+0)*LDA+(OB+0)*LDB+(OC+1)*LDC+(OD+0)*LDD 
      I(OffSet)=CDx*I2Bar3+I2Bar6+I(OffSet)+ABx*V(4)
      OffSet=(OA+0)*LDA+(OB+1)*LDB+(OC+1)*LDC+(OD+0)*LDD 
      I(OffSet)=CDx*I3Bar3+I3Bar6+I(OffSet)+ABy*V(4)
      OffSet=(OA+0)*LDA+(OB+2)*LDB+(OC+1)*LDC+(OD+0)*LDD 
      I(OffSet)=CDx*I4Bar3+I4Bar6+I(OffSet)+ABz*V(4)
      OffSet=(OA+0)*LDA+(OB+0)*LDB+(OC+2)*LDC+(OD+0)*LDD 
      I(OffSet)=CDx*I2Bar4+I2Bar8+I(OffSet)+ABx*V(6)
      OffSet=(OA+0)*LDA+(OB+1)*LDB+(OC+2)*LDC+(OD+0)*LDD 
      I(OffSet)=CDx*I3Bar4+I3Bar8+I(OffSet)+ABy*V(6)
      OffSet=(OA+0)*LDA+(OB+2)*LDB+(OC+2)*LDC+(OD+0)*LDD 
      I(OffSet)=CDx*I4Bar4+I4Bar8+I(OffSet)+ABz*V(6)
      OffSet=(OA+0)*LDA+(OB+0)*LDB+(OC+0)*LDC+(OD+1)*LDD 
      I(OffSet)=CDy*I2Bar2+I2Bar6+I(OffSet)+ABx*V(8)
      OffSet=(OA+0)*LDA+(OB+1)*LDB+(OC+0)*LDC+(OD+1)*LDD 
      I(OffSet)=CDy*I3Bar2+I3Bar6+I(OffSet)+ABy*V(8)
      OffSet=(OA+0)*LDA+(OB+2)*LDB+(OC+0)*LDC+(OD+1)*LDD 
      I(OffSet)=CDy*I4Bar2+I4Bar6+I(OffSet)+ABz*V(8)
      OffSet=(OA+0)*LDA+(OB+0)*LDB+(OC+1)*LDC+(OD+1)*LDD 
      I(OffSet)=CDy*I2Bar3+I2Bar7+I(OffSet)+ABx*V(10)
      OffSet=(OA+0)*LDA+(OB+1)*LDB+(OC+1)*LDC+(OD+1)*LDD 
      I(OffSet)=CDy*I3Bar3+I3Bar7+I(OffSet)+ABy*V(10)
      OffSet=(OA+0)*LDA+(OB+2)*LDB+(OC+1)*LDC+(OD+1)*LDD 
      I(OffSet)=CDy*I4Bar3+I4Bar7+I(OffSet)+ABz*V(10)
      OffSet=(OA+0)*LDA+(OB+0)*LDB+(OC+2)*LDC+(OD+1)*LDD 
      I(OffSet)=CDy*I2Bar4+I2Bar9+I(OffSet)+ABx*V(12)
      OffSet=(OA+0)*LDA+(OB+1)*LDB+(OC+2)*LDC+(OD+1)*LDD 
      I(OffSet)=CDy*I3Bar4+I3Bar9+I(OffSet)+ABy*V(12)
      OffSet=(OA+0)*LDA+(OB+2)*LDB+(OC+2)*LDC+(OD+1)*LDD 
      I(OffSet)=CDy*I4Bar4+I4Bar9+I(OffSet)+ABz*V(12)
      OffSet=(OA+0)*LDA+(OB+0)*LDB+(OC+0)*LDC+(OD+2)*LDD 
      I(OffSet)=CDz*I2Bar2+I2Bar8+I(OffSet)+ABx*V(14)
      OffSet=(OA+0)*LDA+(OB+1)*LDB+(OC+0)*LDC+(OD+2)*LDD 
      I(OffSet)=CDz*I3Bar2+I3Bar8+I(OffSet)+ABy*V(14)
      OffSet=(OA+0)*LDA+(OB+2)*LDB+(OC+0)*LDC+(OD+2)*LDD 
      I(OffSet)=CDz*I4Bar2+I4Bar8+I(OffSet)+ABz*V(14)
      OffSet=(OA+0)*LDA+(OB+0)*LDB+(OC+1)*LDC+(OD+2)*LDD 
      I(OffSet)=CDz*I2Bar3+I2Bar9+I(OffSet)+ABx*V(16)
      OffSet=(OA+0)*LDA+(OB+1)*LDB+(OC+1)*LDC+(OD+2)*LDD 
      I(OffSet)=CDz*I3Bar3+I3Bar9+I(OffSet)+ABy*V(16)
      OffSet=(OA+0)*LDA+(OB+2)*LDB+(OC+1)*LDC+(OD+2)*LDD 
      I(OffSet)=CDz*I4Bar3+I4Bar9+I(OffSet)+ABz*V(16)
      OffSet=(OA+0)*LDA+(OB+0)*LDB+(OC+2)*LDC+(OD+2)*LDD 
      I(OffSet)=I2Bar10+CDz*I2Bar4+I(OffSet)+ABx*V(18)
      OffSet=(OA+0)*LDA+(OB+1)*LDB+(OC+2)*LDC+(OD+2)*LDD 
      I(OffSet)=I3Bar10+CDz*I3Bar4+I(OffSet)+ABy*V(18)
      OffSet=(OA+0)*LDA+(OB+2)*LDB+(OC+2)*LDC+(OD+2)*LDD 
      I(OffSet)=I4Bar10+CDz*I4Bar4+I(OffSet)+ABz*V(18)
   END SUBROUTINE Int1333
